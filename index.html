<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="编程, 计算机科学, 代码, 软件开发" />





  <link rel="alternate" href="/atom.xml" title="VeritasAmat-泠泠御风" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="君子终日乾乾,夕惕若厉,无咎">
<meta property="og:type" content="website">
<meta property="og:title" content="VeritasAmat-泠泠御风">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="VeritasAmat-泠泠御风">
<meta property="og:description" content="君子终日乾乾,夕惕若厉,无咎">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="VeritasAmat-泠泠御风">
<meta name="twitter:description" content="君子终日乾乾,夕惕若厉,无咎">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>







  <title> VeritasAmat-泠泠御风 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?63a07f478f5ee797f027057b4eb21d9e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">VeritasAmat-泠泠御风</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/20/构建F8-App-Appendix-3-将f8移植到windows平台-使用React-Native-开发/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Shaopei Bian">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="VeritasAmat-泠泠御风">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="VeritasAmat-泠泠御风" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/20/构建F8-App-Appendix-3-将f8移植到windows平台-使用React-Native-开发/" itemprop="url">
                  构建F8-App Appendix-3:在windows平台使用React Native 开发
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-20T19:24:09+08:00">
                2016-06-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ReactNative/" itemprop="url" rel="index">
                    <span itemprop="name">ReactNative</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/06/20/构建F8-App-Appendix-3-将f8移植到windows平台-使用React-Native-开发/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/20/构建F8-App-Appendix-3-将f8移植到windows平台-使用React-Native-开发/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/06/20/构建F8-App-Appendix-3-将f8移植到windows平台-使用React-Native-开发/" class="leancloud_visitors" data-flag-title="构建F8-App Appendix-3:在windows平台使用React Native 开发">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>大家可能已经了解到，<a href="https://blogs.windows.com/buildingapps/" target="_blank" rel="external">微软正努力将 React Native 引入到 windows 通用应用平台</a>。对于 React Native 开发者来说，这是一个可以让自己的应用到达 2.7 亿 windows 10 用户（包括手机、电脑、xbox 甚至是 hololens VR眼镜）的绝佳机会。基于同 facebook 的合作以及将 React Native 引入到 windows 所要作出的努力，我们在 windows 应用商店发布了<a href="https://www.microsoft.com/en-us/store/apps/f8-developer-conference/9nblggh4ntvn" target="_blank" rel="external"> F8 开发者大会应用</a>。 所有代码的移植基于最近开源的<a href="https://github.com/fbsamples/f8app" target="_blank" rel="external"> F8 github 代码库</a>。</p>
<p>下面这个视频演示了在UWP( windows 通用应用平台)上运行的 F8 应用中源自 React Native 的部分特性：<br><a href="https://www.youtube.com/watch?v=51_M9Dp5X80&amp;feature=youtu.be" target="_blank" rel="external">https://www.youtube.com/watch?v=51_M9Dp5X80&amp;feature=youtu.be</a><br> (国内用户需翻墙才能查看)</p>
<p>将 F8 应用移植到 windows 平台占用了一个 3 人小组 80/100 的时间，历时 3 周完成。我们将此数据完全透明的公布给大家，主要是基于这样的考虑：决策是否使用 React Native 这样的技术来进行开发，开发效率是一个很重要的参考指标。</p>
<p>虽然我们揭开了 React Native 在 windows 平台开发的序幕，但当前 React Native 的部分核心视图管理器和原生模块在 windows 上仍不可用， React Native 的第三方依赖库也都还不支持 windows 平台。具体就这个应用来说，缺少针对菜单和过滤器的 SplitView 视图管理器；缺少切换 tab 和会话页的FlipView视图管理器; 在滚动视图管理器里面，缺少合适的运行事件用来处理拖拽和内容视图更新。我们也缺少一个剪贴板模块-用来拷贝粘贴 wifi 的详情；缺少用作导航状态存储的异步存储模块；缺少用作登出和其他警告处理的对话框模块；也缺少一个用来处理应用的信息tab页中的链接行为的启动器模块。对于第三方模块，我们缺少<a href="https://github.com/brentvatne/react-native-linear-gradient" target="_blank" rel="external">线性渐变视图管理器</a>、<a href="https://github.com/facebook/react-native-fbsdk" target="_blank" rel="external">facebook sdk 模块</a>、 <a href="https://github.com/EstebanFuentealba/react-native-share" target="_blank" rel="external">React Native 分享模块</a>。其中一部分，例如启动器模块，花了我们小半天时间搞定。其他更复杂的模块，比如 facebook sdk 模块，花了我们超过 1 天的时间；这里主要的工作量在于找到恰当的原生 api 依赖，然后实现功能并且测试。</p>
<p>当我们将要把应用发布到应用商店时，发现有一些细节还没有考虑到：发布到商店的应用必须使用 .net 原生环境编译。我们运气不错，很快搞定了这件事。因为其中只有很少的一部分 api 是 .net 原生环境所不支持的（主要是关于反射方面的）；我们只需要<a href="https://github.com/ReactWindows/react-native/commit/9420ff92f7ccc910ceeb6bb88568675da3abcada" target="_blank" rel="external">解决这部分反射相关的问题</a>。</p>
<p>我们对应用作了一些设计和风格上的调整以让它在 windows phone 上看起来更棒。这里我不会给出太多的细节，因为 <a href="http://makeitopen.com/" target="_blank" rel="external">facebook 已经详细的阐述了如何用 React Native 为 android 和iOS 作平台定制开发</a>, 而这些定制开发的原则也同样适用于 windows 平台。<strong>剔除内核适配、第三方组件适配开发以及发布到应用商店这些工作量，通过 js 语言实现的 windows 平台定制开发和风格调整仅花了 1 名开发者不到 1 周的时间。</strong>请大家留意这个工作量估计，因为在可期待的未来—当 React Native 在 Windows 平台上的成熟度接近 iOS 和 android 的时候，这就是 React Native 应用移植到 windows 时开发者的唯一工作量。下面我给出了一些例子来展现如何让 windows 应用变得不同（与 iOS 和 android 应用相比）。</p>
<p>F8 ListContainer 组件的平台特定风格设置代码:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">var styles = StyleSheet.create(&#123;</div><div class="line"><span class="attr">  container:</span> &#123;</div><div class="line"><span class="attr">    flex:</span> <span class="number">1</span>,</div><div class="line"><span class="attr">    backgroundColor:</span> <span class="string">'white'</span>,</div><div class="line">  &#125;,</div><div class="line"><span class="attr">  listView:</span> &#123;</div><div class="line"><span class="attr">    ios:</span> &#123;</div><div class="line"><span class="attr">      backgroundColor:</span> <span class="string">'transparent'</span>,</div><div class="line">    &#125;,</div><div class="line"><span class="attr">    android:</span> &#123;</div><div class="line"><span class="attr">      backgroundColor:</span> <span class="string">'white'</span>,</div><div class="line">    &#125;,</div><div class="line"><span class="attr">    windows:</span> &#123;</div><div class="line"><span class="attr">      backgroundColor:</span> <span class="string">'white'</span>,</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line"><span class="attr">  headerTitle:</span> &#123;</div><div class="line"><span class="attr">    color:</span> <span class="string">'white'</span>,</div><div class="line"><span class="attr">    fontWeight:</span> <span class="string">'bold'</span>,</div><div class="line"><span class="attr">    fontSize:</span> <span class="number">20</span>,</div><div class="line">  &#125;,</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>F8TabsView.window.js 中：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">F8TabsView</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  ...</div><div class="line"> </div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;<span class="type">F8SplitView</span></div><div class="line">        ref=<span class="string">"splitView"</span></div><div class="line">        paneWidth=&#123;<span class="number">290</span>&#125;</div><div class="line">        panePosition=<span class="string">"left"</span></div><div class="line">        renderPaneView=&#123;<span class="keyword">this</span>.renderPaneView&#125;&gt;</div><div class="line">        &lt;<span class="type">View</span> style=&#123;styles.content&#125; key=&#123;<span class="keyword">this</span>.props.tab&#125;&gt;</div><div class="line">          &#123;<span class="keyword">this</span>.renderContent()&#125;</div><div class="line">        &lt;/<span class="type">View</span>&gt;</div><div class="line">      &lt;/<span class="type">F8SplitView</span>&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line"> </div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对比 F8TabsView.android.js：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">F8TabsView</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  ...</div><div class="line"> </div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;<span class="type">F8DrawerLayout</span></div><div class="line">        ref=<span class="string">"drawer"</span></div><div class="line">        drawerWidth=&#123;<span class="number">290</span>&#125;</div><div class="line">        drawerPosition=<span class="string">"left"</span></div><div class="line">        renderNavigationView=&#123;<span class="keyword">this</span>.renderNavigationView&#125;&gt;</div><div class="line">        &lt;<span class="type">View</span> style=&#123;styles.content&#125; key=&#123;<span class="keyword">this</span>.props.tab&#125;&gt;</div><div class="line">          &#123;<span class="keyword">this</span>.renderContent()&#125;</div><div class="line">        &lt;/<span class="type">View</span>&gt;</div><div class="line">      &lt;/<span class="type">F8DrawerLayout</span>&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line"> </div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对比 F8TabsView.ios.js：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">F8TabsView</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  ...</div><div class="line"> </div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;<span class="type">TabBarIOS</span> tintColor=&#123;<span class="type">F8Colors</span>.darkText&#125;&gt;</div><div class="line">        &lt;<span class="type">TabBarItemIOS</span>&gt;</div><div class="line">          ...</div><div class="line">        &lt;/<span class="type">TabBarItemIOS</span>&gt;</div><div class="line">        ...</div><div class="line">      &lt;/<span class="type">TabBarIOS</span>&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line"> </div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> React Native 的理念是做一个“水平的平台“，意思是更倾向于”learn once, write anywhere”，以区别于 java 的”write once, run everywhere”。虽然我们的 F8 windows 应用体验接近于 Android，但如果有更多的开发时间，我们很可能会修改其界面和菜单让它看起来更像是一个 windows 应用。例如在 XAML 中，SplitView 支持一种紧凑的显示模式，其 panel 关闭时该视图仅从一个下拉菜单里显示所有的 icon 图片。对应用的桌面版本和 <a href="https://msdn.microsoft.com/en-us/library/windows/hardware/dn917883%28v=vs.85%29.aspx" target="_blank" rel="external">continuum</a> 特性来说，这个体验很棒。同时，在 XAML 中 pivot 被广泛用于翻页，拥有 pivot 风格的页面和会话标题对 windows 用户来说将会是更熟悉的体验。</p>
<p>总的来说，我们基于 React Native 将 F8 开发者大会应用移植到 windows 的过程让人感觉很好； React Native 应用移植到 windows 平台也将会变得越来越容易。我们希望我们所作出的努力可以证明在 windows 平台上用 React Native 开发绝不仅仅是实验性质的。通过社区的强大支持，它可能为你的 React Native 应用带来更广泛的受众（来自 windows 平台的用户）；这是一个属于 React Native 开发者的绝好机会。</p>
<p>在 5 月 13 日爱尔兰都柏林举行的 <a href="http://www.decodedshow.com/events/" target="_blank" rel="external">DECODED Conference</a> 上，我们将继续讨论此次移植的经验以及其他一些关于在 windows 上使用 React Native 的议题。此外，这里有一篇文章，分享了另一个微软的团队<a href="http://microsoft.github.io/code-push/articles/ReactNativeWindows.html" target="_blank" rel="external">在 UWP 平台上使用 CodePush 实现 React Native 代码热更新</a>的经验。<br>特别感谢 <a href="https://github.com/mpodwysocki" target="_blank" rel="external">Matt Podwysocki</a> 和 <a href="https://github.com/ebragge" target="_blank" rel="external">Eero Bragge</a> ，是他们的努力工作才得以让 F8 windows 应用如期到来。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/18/构建F8-App-Appendix-2-使用Relay和GraphQL/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Shaopei Bian">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="VeritasAmat-泠泠御风">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="VeritasAmat-泠泠御风" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/18/构建F8-App-Appendix-2-使用Relay和GraphQL/" itemprop="url">
                  构建F8-App Appendix-2:使用Relay和GraphQL
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-18T19:20:44+08:00">
                2016-06-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ReactNative/" itemprop="url" rel="index">
                    <span itemprop="name">ReactNative</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/06/18/构建F8-App-Appendix-2-使用Relay和GraphQL/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/18/构建F8-App-Appendix-2-使用Relay和GraphQL/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/06/18/构建F8-App-Appendix-2-使用Relay和GraphQL/" class="leancloud_visitors" data-flag-title="构建F8-App Appendix-2:使用Relay和GraphQL">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在我们最初构建 app 时，<a href="tutorials/Part 1. Planning The App.md">我们讨论了对数据层的选择</a>。并将我们最终使用的 <a href="https://github.com/rackt/redux" target="_blank" rel="external">Redux</a> 框架与 Facebook 的开源框架 <a href="https://facebook.github.io/relay/" target="_blank" rel="external">Relay</a> 进行了对比。</p>
<p>当时我们选择了 Redux，是因为与 Relay 相比，Redux 提供了更便捷的数据层实现，且与 Parse 的数据存储可以更快更容易的结合使用。</p>
<p>F8 的 iOS 和 Android 的应用开发完成上线后。我们再次回顾对数据层的框架选择，想尝试在我们的 App 中如何使用 Relay。</p>
<h2 id="缓慢的转变"><a href="#缓慢的转变" class="headerlink" title="缓慢的转变"></a>缓慢的转变</h2><p>在传统原生 App 的开发中，更换数据层意味着整个应用的推翻重写，已有的功能都会被全部替换。</p>
<p>React Native 则不同。替换一个独立的 View 的数据层时，已有的绝大部份数据设置逻辑（Redux, Parse, 和相关的绑定），我们都可以保留。不需要重写或大量重构，我们可以只把 App 中的某个模块的数据层替换为新的数据层，其余模块继续使用已有数据层。</p>
<p>需要说明的是，这种逐步改善 App 的能力可以极大的降低维护和升级的开销，对应用的开发非常有利。</p>
<p>那么相比 Redux，使用 Relay 和 GraphQL 如果处理数据层呢？</p>
<h2 id="介绍-Relay-和-GraphQL"><a href="#介绍-Relay-和-GraphQL" class="headerlink" title="介绍 Relay 和 GraphQL"></a>介绍 Relay 和 GraphQL</h2><p>首先，简单的说，<a href="https://facebook.github.io/relay/" target="_blank" rel="external">Relay</a> 是 app 中的一个数据框架。<a href="http://graphql.org/" target="_blank" rel="external">GraphQL</a> 是 Relay 中表示数据模型的查询语言。GraphQL 运行在服务器上，与 app 相隔离，给 Relay 提供交互所需要的数据源(我们之后的教程中会介绍 GraphQL 服务器的搭建，敬请期待)。</p>
<p>Relay 不是 Flux 构架的衍生物，且只能和 GraphQL 配合使用。这就直接意味着和 Redux 模型完全彻底不同。我们在<a href="http://makeitopen.com/tutorials/building-the-f8-app/data/" target="_blank" rel="external">数据层教程</a>中已经介绍的 Store/Reducer/Component 交互在 Relay 中是不存在的。它采用一种不一样的方法，并且移除了你和数据交互时需要做的一些构建工作。</p>
<p>在 Relay 中，各个 React component 具体依赖样的数据，取决于 GraphQL 的使用。Relay 处理一切有关数据获取，当数据改变后更新组件，客户端的数据缓存的事情。当客户端需要修改数据的时候，创建一个 <a href="https://facebook.github.io/relay/docs/guides-mutations.html#content" target="_blank" rel="external">GraphQL Mutation</a> 而不是像使用 Redux 时创建一个 Action.</p>
<h2 id="F8-App-中的一个的例子"><a href="#F8-App-中的一个的例子" class="headerlink" title="F8 App 中的一个的例子"></a>F8 App 中的一个的例子</h2><p>鉴于具有逐渐改变 React Native 应用的一小部分的能力，我们选择把 F8 app 的 Info View 这个模块中的 Redux 替换为 Relay,作为一种概念证明.</p>
<p><img src="http://makeitopen.com/static/images/info_view.png" alt="Info view of F8 iOS app"></p>
<p>Info 这个模块在 app 中和其余模块几乎时彻底分离的，而且大量内容都是非交互性的，用这个模块是最佳选择。</p>
<p>Info View 中包含一个非常简单的 <code>&lt;InfoList&gt;</code> 组件：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/tabs/info/F8InfoView.js */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">InfoList</span>(<span class="params">&#123;viewer: &#123;config, faqs, pages&#125;, ...props&#125;</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> (</div><div class="line">    &lt;PureListView</div><div class="line">      renderEmptyList=&#123;() =&gt; (</div><div class="line">        &lt;View&gt;</div><div class="line">          &lt;WiFiDetails</div><div class="line">            network=&#123;config.wifiNetwork&#125;</div><div class="line">            password=&#123;config.wifiPassword&#125;</div><div class="line">          /&gt;</div><div class="line">          &lt;CommonQuestions faqs=&#123;faqs&#125; /&gt;</div><div class="line">          &lt;LinksList title="Facebook pages" links=&#123;pages&#125; /&gt;</div><div class="line">          &lt;LinksList title="Facebook policies" links=&#123;POLICIES_LINKS&#125; /&gt;</div><div class="line">        &lt;/View&gt;</div><div class="line">      )&#125;</div><div class="line">      &#123;...props&#125;</div><div class="line">    /&gt;</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这只是包含一些简单信息展示类组件的基本布局，但组件中的 <code>props</code> 和参数从哪来的呢？哈哈，在这个 js 文件中，我们有一个连接 GraphQL 的 <code>fragment</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/tabs/info/F8InfoView.js */</span></div><div class="line">InfoList = Relay.createContainer(InfoList, &#123;</div><div class="line">  <span class="attr">fragments</span>: &#123;</div><div class="line">    <span class="attr">viewer</span>: <span class="function"><span class="params">()</span> =&gt;</span> Relay.QL<span class="string">`</span></div><div class="line">      fragment on User &#123;</div><div class="line">        config &#123;</div><div class="line">          wifiNetwork</div><div class="line">          wifiPassword</div><div class="line">        &#125;</div><div class="line">        faqs &#123;</div><div class="line">          question</div><div class="line">          answer</div><div class="line">        &#125;</div><div class="line">        pages &#123;</div><div class="line">          title</div><div class="line">          url</div><div class="line">          logo</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    `,</div><div class="line">  &#125;,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这里，我们用一个 GraphSQL <code>fragment</code> 定义了 <code>&lt;InfoList&gt;</code> 组件需要展示的数据。它和我们在 GraphQL 服务器上定义的 GraphQL 对象是对应的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from server/schema/schema.js */</span></div><div class="line"><span class="keyword">var</span> F8UserType = <span class="keyword">new</span> GraphQLObjectType(&#123;</div><div class="line">  <span class="attr">name</span>: <span class="string">'User'</span>,</div><div class="line">  <span class="attr">description</span>: <span class="string">'A person who uses our app'</span>,</div><div class="line">  <span class="attr">fields</span>: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</div><div class="line">    <span class="attr">id</span>: globalIdField(<span class="string">'User'</span>),</div><div class="line">    <span class="attr">name</span>: &#123;</div><div class="line">      <span class="attr">type</span>: GraphQLString,</div><div class="line">    &#125;,</div><div class="line">    ...</div><div class="line">    faqs: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="keyword">new</span> GraphQLList(F8FAQType),</div><div class="line">      <span class="attr">resolve</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">new</span> Parse.Query(FAQ).find(),</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">pages</span>: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="keyword">new</span> GraphQLList(F8PageType),</div><div class="line">      <span class="attr">resolve</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">new</span> Parse.Query(Page).find(),</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">config</span>: &#123;</div><div class="line">      <span class="attr">type</span>: F8ConfigType,</div><div class="line">      <span class="attr">resolve</span>: <span class="function"><span class="params">()</span> =&gt;</span> Parse.Config.get(),</div><div class="line">    &#125;</div><div class="line">  &#125;),</div><div class="line">  ...</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>你可以看到数据是如何从 GraphQL 服务器上被获取的，然后 Relay 开始接手所有需要的且在 <code>fragment</code> 中指定的数据。这时 <code>viewer</code> 的参数就可以被 <code>&lt;InfoList&gt;</code> 组件访问到了，使用了一些 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment" target="_blank" rel="external">destructuring assignments</a>，反过来构建了在组件中使用的 <code>config</code>， <code>faq</code>，<code>pages</code> 变量。</p>
<p>归功于 Relay 的内建逻辑，我们不用担心数据变化的监听，或者数据本地储存等等。我们只需要告诉 Relay 组件中应该有什么数据，然后以标准的 React 方式来设计我们需要的组件。如果 GraphQL 服务器已经搭建好，以上就是我们需要做的所有事情。</p>
<p>我们的 Info View 中没有数据的变化，然而如果你想了解更多原理，请阅读在 <a href="https://facebook.github.io/relay/docs/guides-mutations.html#content" target="_blank" rel="external">Relay 在 mutations 上面的文档</a>。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/15/构建F8-App-Appendix-1-本地运行App/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Shaopei Bian">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="VeritasAmat-泠泠御风">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="VeritasAmat-泠泠御风" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/15/构建F8-App-Appendix-1-本地运行App/" itemprop="url">
                  构建F8-App Appendix-1:本地运行App
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-15T19:18:27+08:00">
                2016-06-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ReactNative/" itemprop="url" rel="index">
                    <span itemprop="name">ReactNative</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/06/15/构建F8-App-Appendix-1-本地运行App/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/15/构建F8-App-Appendix-1-本地运行App/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/06/15/构建F8-App-Appendix-1-本地运行App/" class="leancloud_visitors" data-flag-title="构建F8-App Appendix-1:本地运行App">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>当你从<a href="https://itunes.apple.com/us/app/f8/id853467066" target="_blank" rel="external">苹果商店</a>或者<a href="https://itunes.apple.com/us/app/f8/id853467066" target="_blank" rel="external">谷歌 Play</a> 上下载了 F8 App，并可以在移动设备上运行它以后，阅读这些教程的同时你也会希望在本地运行 App 玩一玩。</p>
<p>这篇简短的文章，将指导你如何在 OSX 本地搭建和运行源代码（安卓版 React Native <a href="http://facebook.github.io/react-native/docs/linux-windows-support.html#content" target="_blank" rel="external">可以支持</a>在 Windows 和 Linux 运行）。</p>
<p>##要求</p>
<p>在开始之前，你需要安装一些必要的东西：</p>
<ol>
<li><a href="http://facebook.github.io/react-native/docs/getting-started.html" target="_blank" rel="external">React Native</a> (根据 iOS 和 Android 的引导说明)</li>
<li><a href="http://cocoapods.org/" target="_blank" rel="external">CocoaPods</a> 1.0+ (仅 iOS)</li>
<li><a href="https://www.mongodb.org/downloads" target="_blank" rel="external">MongoDB</a> (需要在本地运行 Parse Server)</li>
</ol>
<p>##搭建</p>
<p>####1. 克隆仓库<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git <span class="keyword">clone</span> <span class="title">https</span>://github.com/fbsamples/f8app.git</div><div class="line">$ cd f8app</div></pre></td></tr></table></figure></p>
<p>####2. 安装依赖（npm v3+）<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ npm <span class="keyword">install</span></div><div class="line">$ (cd ios; pod <span class="keyword">install</span>)        # <span class="keyword">only</span> <span class="keyword">for</span> iOS <span class="keyword">version</span></div></pre></td></tr></table></figure></p>
<p>####3. 确认 MongoDB 运行正常<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ lsof -<span class="string">iTCP:</span><span class="number">27017</span> -<span class="string">sTCP:</span>LISTEN</div></pre></td></tr></table></figure></p>
<p>或者使用外部 MongoDB 服务，设置 <code>DATABASE_URI</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">export</span> DATABASE_URI=mongodb:<span class="comment">//example-mongo-hosting.com:1337/my-awesome-database</span></div></pre></td></tr></table></figure>
<p>####4. 启动 Parse/GraphQL 服务<br><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">npm</span> start</div></pre></td></tr></table></figure></p>
<p>####5. 导入样本数据（本地的 Parse 服务已经运行）<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm run <span class="keyword">import</span>-<span class="keyword">data</span></div></pre></td></tr></table></figure></p>
<p>访问以下地址确认一切正常运行：</p>
<ul>
<li>Parse Dashboard: <a href="http://localhost:8080/dashboard" target="_blank" rel="external">http://localhost:8080/dashboard</a></li>
<li>GraphiQL: <a href="http://localhost:8080/graphql" target="_blank" rel="external">http://localhost:8080/graphql</a></li>
</ul>
<p><img src="http://makeitopen.com/static/images/screenshot-server@2x.png" alt=""></p>
<p>####6. 运行 Android 版 App<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ react-native <span class="built_in">run</span>-android</div><div class="line">$ adb <span class="built_in">reverse</span> tcp:<span class="number">8081</span> tcp:<span class="number">8081</span>   <span class="comment"># required to ensure the Android app can</span></div><div class="line">$ adb <span class="built_in">reverse</span> tcp:<span class="number">8080</span> tcp:<span class="number">8080</span>   <span class="comment"># access the Packager and GraphQL server</span></div></pre></td></tr></table></figure></p>
<p>####7. 运行 iOS 版 App<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ react-native <span class="keyword">run</span><span class="bash">-ios</span></div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/14/构建F8-App-part4/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Shaopei Bian">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="VeritasAmat-泠泠御风">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="VeritasAmat-泠泠御风" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/14/构建F8-App-part4/" itemprop="url">
                  构建F8-App part4
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-14T19:13:32+08:00">
                2016-06-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ReactNative/" itemprop="url" rel="index">
                    <span itemprop="name">ReactNative</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/06/14/构建F8-App-part4/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/14/构建F8-App-part4/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/06/14/构建F8-App-part4/" class="leancloud_visitors" data-flag-title="构建F8-App part4">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在传统软件开发生命周期里，测试环节通常往往仅仅是作为一个临近开发结束时才开始进行的特殊环节。由于新推出开源框架发布时往往并未有任何相关测试技术支持，当使用这些框架进行开发时，这种说法便更接近事实真相。</p>
<p>   幸运的是， Facebook 在 React Native 构建之初很早的就考虑到了测试策略。在这部分我们将介绍编码阶段如何使用  <a href="http://nuclide.io/" target="_blank" rel="external">Nuclide</a> ,  <a href="http://flowtype.org/" target="_blank" rel="external">Flow</a> ,  以及 <a href="http://facebook.github.io/jest/" target="_blank" rel="external">Jest</a> 改善 React Native 代码质量。</p>
<h2 id="Flow-利用类型检查避免编写糟糕代码"><a href="#Flow-利用类型检查避免编写糟糕代码" class="headerlink" title="Flow : 利用类型检查避免编写糟糕代码"></a>Flow : 利用类型检查避免编写糟糕代码</h2><p><a href="http://flowtype.org/" target="_blank" rel="external">Flow</a>为JavaScript 提供以渐进方式工作的<a href="http://flowtype.org/docs/about-flow.html#_" target="_blank" rel="external">静态类型检查</a>，允许我们将 Flow 特性逐步添加到代码中。这是个非常有用的设计。当我们仅仅想为部分代码引入类型检查时， 我们不必为兼容 Flow 而去重写整个 app 。</p>
<p>我们决定从一开始就完全采用 Flow 来配合 React Native 搭建 F8app，在一切必要的地方添加<a href="http://flowtype.org/docs/type-annotations.html#_" target="_blank" rel="external">类型注解(type annotations )</a> ，让 Flow 能在整个代码开发过程中一直尽情发挥力量。</p>
<p>下面我们以曾经在<a href="http://makeitopen.com/tutorials/building-the-f8-app/data/" target="_blank" rel="external">数据教程</a>部分曾提及的一个简单 action 作为示例：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/actions/login.js */</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * @flow</div><div class="line"> */</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">function skipLogin(): Action &#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">type</span>: <span class="string">'SKIPPED_LOGIN'</span>,</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们在文件顶部添加 @Flow 标签（<a href="http://flowtype.org/docs/getting-started.html#_" target="_blank" rel="external">通知 Flow 需检查此段代码</a>）。我们使用 Flow 的<a href="http://flowtype.org/docs/type-annotations.html#_" target="_blank" rel="external">类型注解</a> 限定 skipLogin() 返回值类型必须是 type Action ，由于该Action类型并未在 React Native 及 Redux 里内置，因此在这里我们需要自己对该类型进行定义：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> type Action =</div><div class="line">    &#123; <span class="attr">type</span>: <span class="string">'LOADED_ABOUT'</span>, <span class="attr">list</span>: <span class="built_in">Array</span>&lt;ParseObject&gt; &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'LOADED_NOTIFICATIONS'</span>, <span class="attr">list</span>: <span class="built_in">Array</span>&lt;ParseObject&gt; &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'LOADED_MAPS'</span>, <span class="attr">list</span>: <span class="built_in">Array</span>&lt;ParseObject&gt; &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'LOADED_FRIENDS_SCHEDULES'</span>, <span class="attr">list</span>: <span class="built_in">Array</span>&lt;&#123; <span class="attr">id</span>: string; name: string; schedule: &#123;[key: string]: boolean&#125;; &#125;&gt; &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'LOADED_CONFIG'</span>, <span class="attr">config</span>: ParseObject &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'LOADED_SESSIONS'</span>, <span class="attr">list</span>: <span class="built_in">Array</span>&lt;ParseObject&gt; &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'LOADED_SURVEYS'</span>, <span class="attr">list</span>: <span class="built_in">Array</span>&lt;<span class="built_in">Object</span>&gt; &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SUBMITTED_SURVEY_ANSWERS'</span>, <span class="attr">id</span>: string; &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'LOGGED_IN'</span>, <span class="attr">data</span>: &#123; <span class="attr">id</span>: string; name: string; sharedSchedule: ?boolean; &#125; &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'RESTORED_SCHEDULE'</span>, <span class="attr">list</span>: <span class="built_in">Array</span>&lt;ParseObject&gt; &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SKIPPED_LOGIN'</span> &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'LOGGED_OUT'</span> &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SESSION_ADDED'</span>, <span class="attr">id</span>: string &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SESSION_REMOVED'</span>, <span class="attr">id</span>: string &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SET_SHARING'</span>, <span class="attr">enabled</span>: boolean &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'APPLY_TOPICS_FILTER'</span>, <span class="attr">topics</span>: &#123;[key: string]: boolean&#125; &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'CLEAR_FILTER'</span> &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SWITCH_DAY'</span>, <span class="attr">day</span>: <span class="number">1</span> | <span class="number">2</span> &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SWITCH_TAB'</span>, <span class="attr">tab</span>: <span class="string">'schedule'</span> | <span class="string">'my-schedule'</span> | <span class="string">'map'</span> | <span class="string">'notifications'</span> | <span class="string">'info'</span> &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'TURNED_ON_PUSH_NOTIFICATIONS'</span> &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'REGISTERED_PUSH_NOTIFICATIONS'</span> &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SKIPPED_PUSH_NOTIFICATIONS'</span> &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'RECEIVED_PUSH_NOTIFICATION'</span>, <span class="attr">notification</span>: <span class="built_in">Object</span> &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SEEN_ALL_NOTIFICATIONS'</span> &#125;</div><div class="line">  | &#123; <span class="attr">type</span>: <span class="string">'RESET_NUXES'</span> &#125;</div><div class="line">  ;</div></pre></td></tr></table></figure></p>
<p>这里我们创建了 <a href="http://flowtype.org/docs/type-aliases.html#_" target="_blank" rel="external">Flow 类型别名（ Flow type alias ）</a>，限定了 type Action 的样式范围。比如，SKIPPED_LOGIN Action 仅能包含一个自己的type标签， LOADED_SURVEYS Action 则会返回 type 标签以及一个 list 列表。相关 Action Creator 如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/actions/surveys.js */</span></div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">loadSurveys</span>(<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">Action</span>&gt; </span>&#123;</div><div class="line">  <span class="keyword">const</span> list = <span class="keyword">await</span> Parse.Cloud.run(<span class="string">'surveys'</span>);</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">type</span>: <span class="string">'LOADED_SURVEYS'</span>,</div><div class="line">    list,</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们在 app 里使用了大量不同 Action ，强类型检查除了会帮助我们发现类似 type 标签拼写错误这样的低级错误，还会发现如数据格式错误这样的比较重要的问题。</p>
<p>我们在 Reducers 也进行了一样的强类型检查：mp<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/reducers/surveys.js */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">surveys</span>(<span class="params">state: State = [], action: Action</span>): <span class="title">State</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (action.type === <span class="string">'LOADED_SURVEYS'</span>) &#123;</div><div class="line">    <span class="keyword">return</span> action.list;</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">  return state;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由于 <strong>action</strong> 参数被指定为与前面一样的 <strong>Action</strong> 类型，因此 Reducer 函数必须使用一个有效的 <strong>action.type</strong> 。我们通过类型别名为 Reducer <strong>state</strong> 树选项定义样式:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/reducers/user.js */</span></div><div class="line"><span class="keyword">export</span> type State = &#123;</div><div class="line">  <span class="attr">isLoggedIn</span>: boolean;</div><div class="line">  hasSkippedLogin: boolean;</div><div class="line">  sharedSchedule: ?boolean;</div><div class="line">  id: ?;</div><div class="line">  name: ?string;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">const</span> initialState = &#123;</div><div class="line">  <span class="attr">isLoggedIn</span>: <span class="literal">false</span>,</div><div class="line">  <span class="attr">hasSkippedLogin</span>: <span class="literal">false</span>,</div><div class="line">  <span class="attr">sharedSchedule</span>: <span class="literal">null</span>,</div><div class="line">  <span class="attr">id</span>: <span class="literal">null</span>,</div><div class="line">  <span class="attr">name</span>: <span class="literal">null</span>,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">user</span>(<span class="params">state: State = initialState, action: Action</span>): <span class="title">State</span> </span>&#123;</div><div class="line">  ...</div><div class="line">&#125;</div><div class="line"><span class="string">``</span><span class="string">`  </span></div><div class="line">我们在[数据教程][6]部分曾为你展示过 **initialState** ，现在你会看到，我们是怎样保证 **state** 树选项与 Flow 定义的类型相一致。当 Reducer 发送或者尝试返回任何不符合定义样式的 **state** 时，都会发生 Flow 类型检查错误。</div><div class="line"></div><div class="line">请注意， Folw 检查仅在编译阶段运行， Recat Native packger 则会[自动去除][9]-这意味着在代码中使用 Flow 不会造成任何执行性能损失。</div><div class="line"></div><div class="line">当然，目前每次想对某些代码进行测试时，我们仍然需要手动运行 Flow 类型检查（通过[ Flow 命令行接口][10]）。不过我们可以通过 Nuclide 在编码时进行这样的查验。</div><div class="line">##Nuclide：React Native 开发环境</div><div class="line">[Nuclide 网站][11]上有为 React Native 提供的定制功能的全面介绍。我必须得说， Neculite 是专为 React Native 的 Facebook 研发团队以及 Facebook app 专业研发人员而开发的顶级 React Native IDE 。</div><div class="line"></div><div class="line">Nuclite 对 Flow 的集成格外让我们感兴趣。在这里让我们看看 user Reducer 的一段代码：</div><div class="line">`<span class="string">``</span>javascript</div><div class="line"><span class="keyword">if</span> (action.type === <span class="string">'SKIPPED_LOGIN'</span>) &#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      <span class="attr">isLoggedIn</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">hasSkippedLogin</span>: <span class="literal">true</span>,</div><div class="line">      <span class="attr">sharedSchedule</span>: <span class="literal">null</span>,</div><div class="line">      <span class="attr">id</span>: <span class="literal">null</span>,</div><div class="line">      <span class="attr">name</span>: <span class="literal">null</span>,</div><div class="line">    &#125;;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>前面有提到，我们为 Reducer 函数定义了返回值样式。在 Nuclide ，我们可以实时看到错误发生：</p>
<video width="1174" height="1002" autoplay loop><br>  <source src="static/videos/flow.mp4" type="video/mp4"><br>  Your browser does not support the HTML5 video tag.<br></video>

<p>若我们有遗漏了 State 类型的任何部分，我们会瞬间收到内容为未返回正确对象类型的反馈。这种概率事件在快速构建 app 时会频繁发生。</p>
<p>Nuclite 对所有相关 Flow 类型检查都是如此。这意味着在代码还在编写时，类型错误便能暴露出来，同时我们还能对相关问题进行修正。而这一切无需再等到到开发接近完成时才进行。</p>
<p>这或许并不直观，但确实提高了开发速度。要想在代码中发现遗漏真的是件很困难的事。而在 app 接近开发完成时，这会更加棘手。</p>
<p>##Jest : 对可能造成 BUG 的改动进行单元测试<br><a href="http://facebook.github.io/jest/" target="_blank" rel="external">jest</a> 是一个面向 JavaScipt 的单元测试框架，同时它在 <a href="http://facebook.github.io/react-native/docs/testing.html#content" target="_blank" rel="external">React Native app</a>下也表现不俗。</p>
<p>我们h会用这些单元测试（也被称作回归测试）来确保对已经开发完成的结构化代码的改动并未引入 bug 。</p>
<p>作为例子，下面我们准备通过一个 Jest 测试来保证 Reducer 能够继续按预期处理地图数据：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">jest.autoMockOff();</div><div class="line"></div><div class="line"><span class="keyword">const</span> Parse = <span class="built_in">require</span>(<span class="string">'parse'</span>);</div><div class="line"><span class="keyword">const</span> maps = <span class="built_in">require</span>(<span class="string">'../maps'</span>);</div><div class="line"></div><div class="line">describe(<span class="string">'maps reducer'</span>, () =&gt; &#123;</div><div class="line"></div><div class="line">  it(<span class="string">'is empty by default'</span>, () =&gt; &#123;</div><div class="line">    expect(maps(<span class="literal">undefined</span>, &#123;&#125;)).toEqual([]);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  it(<span class="string">'populates maps from server'</span>, () =&gt; &#123;</div><div class="line">    <span class="keyword">let</span> list = [</div><div class="line">      <span class="keyword">new</span> Parse.Object(&#123;<span class="attr">mapTitle</span>: <span class="string">'Day 1'</span>, <span class="attr">mapImage</span>: <span class="keyword">new</span> Parse.File(<span class="string">'1.png'</span>)&#125;),</div><div class="line">      <span class="keyword">new</span> Parse.Object(&#123;<span class="attr">mapTitle</span>: <span class="string">'Day 2'</span>, <span class="attr">mapImage</span>: <span class="keyword">new</span> Parse.File(<span class="string">'2.png'</span>)&#125;),</div><div class="line">    ];</div><div class="line"></div><div class="line">    expect(</div><div class="line">      maps([], &#123;<span class="attr">type</span>: <span class="string">'LOADED_MAPS'</span>, list&#125;)</div><div class="line">    ).toEqual([&#123;</div><div class="line">      <span class="attr">id</span>: jasmine.any(<span class="built_in">String</span>),</div><div class="line">      <span class="attr">title</span>: <span class="string">'Day 1'</span>,</div><div class="line">      <span class="attr">url</span>: <span class="string">'1.png'</span>,</div><div class="line">    &#125;, &#123;</div><div class="line">      <span class="attr">id</span>: jasmine.any(<span class="built_in">String</span>),</div><div class="line">      <span class="attr">title</span>: <span class="string">'Day 2'</span>,</div><div class="line">      <span class="attr">url</span>: <span class="string">'2.png'</span>,</div><div class="line">    &#125;]);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>Jest 本身非常易于阅读（注意：我们甚至对 Jest 测试部分都使用了 Flow 来定义类型），不过我们还是会对此进行进一步的分解。在第 4 行，我们引入了地图的 Reducer 函数(<strong>js/reducers/maps.js</strong>) 这样便能在单元测试中直接调用（Reducer  函数作为 <a href="https://en.wikipedia.org/wiki/Pure_function" target="_blank" rel="external">pure functions</a> 能够很容易完成这些）。</p>
<p>第一段测试代码位于第 8 行，目的是确保 Recucer 函数返回一个空数组。观察  <strong>js/reducers/maps</strong> 处 Reducer 代码，你会发现 state 并未做任何初始化，因此我们会期待期待单元测试结果为返回空数组。</p>
<p>第二段测试代码位于第 12 行，目的是确保地图数据被解析 API 检索到的时候能够被 Reducer 函数转化成 <strong>state</strong> 树中对应的正确结构。在这个测试中，我们使用假数据完全模拟真实 API 返回数据结构，这将避免API连接问题导致的测试失败。</p>
<p>现在我们已经令跑 Jest 测试成为开发工作流程（比如每次提交 git 前）的一部分。这样我们能确保对现有代码的改动不会令 app 默默阵亡。</p>
<p>由于 Redux Reducers 会改变 <strong>state</strong> 树，不引入 bug 变得绝对至关重要。由 <strong>state</strong> 改变引发的 bug 很容易被忽略。因为它们并 不会造成功能不可用，而仅仅只是造成往 Parse Server 发送错误数据的问题。 Reducer 函数的 pure function 特性令它们成为回归测试的理想对象，因为每次我们都可以准确预知它们会如何执行。</p>
<p>##调试<br>在你试图对 bug 定位或者修复时，手边有一些调试工具的话。我们已经介绍了<a href="http://makeitopen.com/tutorials/building-the-f8-app/design/#the-design-iteration-cycle" target="_blank" rel="external">如何搭建app可视元素调试系统</a>，那这么处理数据呢？</p>
<p>我们通过 <a href="http://nuclide.io/" target="_blank" rel="external">Nuclite</a> 和 <a href="http://fcomb.github.io/redux-logger/" target="_blank" rel="external">Redux Logger middleware</a> 来调用<a href="https://facebook.github.io/react-native/docs/debugging.html#chrome-developer-tools" target="_blank" rel="external"> Chrome 开发者工具</a>（ Chrome Developer Tools ），控制台上展示类似 Actions 或 Reducers 中 state 变动这样的新增 Redux 上下文（ context ）:<br><img src="http://makeitopen.com/static/images/redux_logger.png" alt="iOS and Android Segmented Controls Comparison"><br>你可以看到我们是如何通过<strong>configurestore</strong>来启动这个的：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/store/configureStore.js */</span></div><div class="line"><span class="keyword">var</span> createLogger = <span class="built_in">require</span>(<span class="string">'redux-logger'</span>);</div><div class="line">...</div><div class="line">var isDebuggingInChrome = __DEV__ &amp;&amp; !!<span class="built_in">window</span>.navigator.userAgent;</div><div class="line"><span class="keyword">var</span> logger = createLogger(&#123;</div><div class="line">  <span class="attr">predicate</span>: <span class="function">(<span class="params">getState, action</span>) =&gt;</span> isDebuggingInChrome,</div><div class="line">  <span class="attr">collapsed</span>: <span class="literal">true</span>,</div><div class="line">  <span class="attr">duration</span>: <span class="literal">true</span>,</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">var</span> createF8Store = applyMiddleware(thunk, promise, array, logger)(createStore);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">configureStore</span>(<span class="params">onComplete: ?(</span>) =&gt; <span class="title">void</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> store = autoRehydrate()(createF8Store)(reducers);</div><div class="line">  persistStore(store, &#123;<span class="attr">storage</span>: AsyncStorage&#125;, onComplete);</div><div class="line">  <span class="keyword">if</span> (isDebuggingInChrome) &#123;</div><div class="line">    <span class="built_in">window</span>.store = store;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> store;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在第 5 行，我们<a href="https://github.com/fcomb/redux-logger#options-1" target="_blank" rel="external">通过一些选项</a>创建了 Logger middleware 。 接着，在第 10 行我们调用 Redux 的<a href="http://redux.js.org/docs/api/applyMiddleware.html" target="_blank" rel="external"> <strong>applyMiddleware()</strong> 函数</a>开始应用 Logger middleware 。这样，我们便可以在控制台上看到日志输出了。</p>
<p>在第4行我们使用<a href="http://www.w3schools.com/js/js_scope.asp" target="_blank" rel="external">全局变量</a> <strong><strong>DEV</strong></strong>  来触发调试功能，通过布尔值的改动来在调试模式的开关间进行切换。这一举措除了会决定 Logger middleware 创建后是否记录日志（通过<a href="https://github.com/fcomb/redux-logger#predicate--getstate-function-action-object--boolean" target="_blank" rel="external"><strong>断言</strong>选项</a>），还会在第17行 拷贝当前 Store 到 <a href="http://www.w3schools.com/jsref/obj_window.asp" target="_blank" rel="external">Window object</a> ，如此就可以更容易的通过控制台来直接查看 Store 对象。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/08/构建F8-App-part3/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Shaopei Bian">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="VeritasAmat-泠泠御风">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="VeritasAmat-泠泠御风" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/08/构建F8-App-part3/" itemprop="url">
                  构建F8-App part3
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-08T19:10:42+08:00">
                2016-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ReactNative/" itemprop="url" rel="index">
                    <span itemprop="name">ReactNative</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/06/08/构建F8-App-part3/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/08/构建F8-App-part3/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/06/08/构建F8-App-part3/" class="leancloud_visitors" data-flag-title="构建F8-App part3">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://facebook.github.io/react/" target="_blank" rel="external">React</a> 和 其扩展 <a href="http://facebook.github.io/react-native/" target="_blank" rel="external">React Native</a>，允许在你构建应用程序，而无需担心你的数据来自哪里，这样你就可以专注于创建应用的UI和逻辑。</p>
<p>在<a href="http://makeitopen.com/tutorials/building-the-f8-app/planning/" target="_blank" rel="external">第一章</a>，我们提到如何采用 Parse Server 来持有数据，在 app 中我们将用 Redux 来处理它。在这一部分，我们将解释 Redux 在 React Native 应用中如何工作，以及连接 Parse Server 的简单过程。</p>
<p>在我们讨论 Redux 之前，让我们先看看 React 的数据交互是如何创建 Redux 的。</p>
<h2 id="首先，React-应用如何同数据交互？"><a href="#首先，React-应用如何同数据交互？" class="headerlink" title="首先，React 应用如何同数据交互？"></a>首先，React 应用如何同数据交互？</h2><p>在MVC应用程序架构中， React 被经常性的视为 ‘View’ 层，但是这样的说法显然欠妥，React 实际上是对 MVC 模式的重新构想。</p>
<p>让我们先看下 MVC 架构的基本思想：</p>
<ul>
<li>模型层就是数据层。</li>
<li>视图层负责整个应用程序数据的展现。</li>
<li>控制层在应用程序中负责提供数据处理的逻辑操作。</li>
</ul>
<p>React 可以做到当你创建多个组件组合形成一个视图的时候，每个组件依然可以处理自有逻辑，且只需要提供一个控制器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">    render() &#123;</div><div class="line">        <span class="comment">// Code that renders the view of the existing data, and</span></div><div class="line">        <span class="comment">// potentially a form to trigger changes to that data through</span></div><div class="line">        <span class="comment">// the handleSubmit function</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    handleSubmit(e) &#123;</div><div class="line">        <span class="comment">// Code that modifies the data, like a controller's logic</span></div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>在一个 React 应用中，每个组件都有两种不同的数据类型，每一个都有不同的角色：</p>
<ul>
<li><p><code>props</code> 当一个组件被创建的时候， <code>props</code> 会被作为参数传递给该组件。如果你有一个按钮，默认的 <code>prop</code> 将会是该按钮的文本。组件并不能改变它们的 props (即它们是不可变的)。</p>
</li>
<li><p><code>state</code> 是一种可以被任意组件改变任意次数的数据。如果上面的按钮是登录/注销按钮，那么该 <code>state</code> 将记录用户当前的登录状态，并且该按钮也可以访问它，修改它当用户点击了按钮改变其状态。</p>
</li>
</ul>
<p>为了让 React 应用 减少重复， <code>state</code> 被设计为组件库中的最高级父组件所拥有，即前面提到过的<code>container 组件</code>。换句话说，在上个按钮组件例子中，实际上该按钮并没有拥有该属性，你可以在该按钮的父视图中拥有它，然后使用 <code>props</code> 传递相关的 <code>state</code> 数据给子组件。正因为如此，数据仅仅流向任何给定的应用，这会使得 React 更快和模块化。</p>
<p>如果你愿意，你可以从 <code>thinking-in-react</code> 中阅读更多关于制定这些决策的背后想法和原因。</p>
<p>##存储状态</p>
<p>为了进一步解释在 React 应用中的数据使用技术， Facebook 推荐了 <code>Flux architecture</code>,该架构是一种模式来实现你的应用，而不是一种实际的框架供你使用。我们不在在你的应用中使用 <code>Flux library</code> ,但是我们会使用 Redux 框架，其源于 Flux architecture，所以让我们深入进去吧。</p>
<p>Flux 通过引入 Stores 概念，应用的 <code>state</code> 对象容器，新的工作流用来修改 <code>state</code> 等来扩展 React 的 数据关系：</p>
<ul>
<li>在 Flux 应用中每个在 Dispatcher 中注册过的 Store 都有一个回调方法。</li>
<li>Views (基于 React 组件) 可以触发 Actions ，基本上每个对象，都包含了一堆刚刚发生事情的数据（例如，可能它包括一些将会被输入到应用中的新数据）和 action type (实质上就是 Action 动作的描述类型常量)。</li>
<li>Action 被发送到 Dispatcher 。</li>
<li>Dispatcher 传递该 Action 到所有 Store 的注册回调。</li>
<li>如果 Store 能告知其被一个 Action影响（因为 action 类型和数据相关），其会自动更新，当然其包含的 <code>state</code> 也会被更新。一旦更新，其会发出变化事件。</li>
<li>特殊的视图被叫做 Controller Views(container components的优雅术语)将会监听这些变化事件，当其抓获某事件，它们知道应该获取新的 Store 数据。</li>
<li>一旦获取到新数据后，它们会调用 <code>setState()</code> ，其会致使在该视图里的组件重新 render 。</li>
</ul>
<p>你可以看到在 React 应用中 Flux 如何帮助 React 强制执行 one-way flow 策略 ，并且其会使得 React 的数据部分更加优雅和有结构。</p>
<p>我们现在不使用 Flux ,所以在这篇文章里不会再有更多该细节，但是如果你想了解更多，这儿有一些在 Flux 网站的<a href="https://facebook.github.io/flux/docs/todo-list.html" target="_blank" rel="external">教程</a>可以阅读。</p>
<p>所以 Redux 关 Flux 什么事，在我们应用中实际使用框架 Redux 呢？</p>
<h2 id="Flux-到-Redux"><a href="#Flux-到-Redux" class="headerlink" title="Flux 到 Redux"></a>Flux 到 Redux</h2><p>Redux 是 Flux 架构的框架实现，但是其也可以剥离开来，react-redux package 提供的 official bindings provided 可以让其和 React 应用更方便的融合。</p>
<p>在 Redux 中没有 dispatcher ,并且针对整个应用程序只有一个 Store。</p>
<p>在 Redux中，数据流如何工作，在后续我们有更详细的解释，但是这儿我们先介绍几个基本概念：</p>
<ul>
<li>React 组件可以导致 Actions 被触发，例如按钮的点击。</li>
<li>Actions 是一个通过 <code>dispatch</code> 方法 被发送到 Store 的对象（包括一个 <code>type</code> 标签和 Action相关的其他数据）。</li>
<li>然后 Store 承载着相关 Action ,同当前 <code>state</code> 树（ <code>state</code> 树是一个单独的对象包含了所有的 <code>state</code> 数据）将其发送到 Reducers。</li>
<li>Reducer 是一个纯函数，它维持着之前的状态和动作，然后返回一个基于任何变化的动作的 <code>state</code>。 Redux 应用只能包含一个 Reducer，但是大部分应用最后都会有几个，并且每个都会处理 <code>state</code> 的不同部分（我们将讨论这个）</li>
<li>Store 接收到新的 <code>state</code> ，然后替换掉旧的。这里值得注意的是，当我们讨论 <code>state</code> 更新时，这其实是技术上的取代。</li>
<li>当 <code>state</code> 发生变化时， Store 触发<a href="http://redux.js.org/docs/api/Store.html#subscribe" target="_blank" rel="external">变化事件</a>。</li>
<li>任何<a href="http://redux.js.org/docs/api/Store.html#subscribe" target="_blank" rel="external">订阅了该变化事件</a>的 React 组件都会<a href="http://redux.js.org/docs/api/Store.html#getState" target="_blank" rel="external">收到来自 Store 的新 <code>state</code></a>。</li>
<li>组件随 <code>state</code> 而更新。</li>
</ul>
<p>该工作流可以通过下图简单总结：</p>
<p>![redux_flowchart](<a href="http://makeitopen.com/static/images/redux_flowchart.png）" target="_blank" rel="external">http://makeitopen.com/static/images/redux_flowchart.png）</a></p>
<p>你可以看到数据是如何遵循一个明确的单向通道，没有重叠或相反的方向流动。这也说明 Redux 可以将 app 的每一部分细分。 Store 只关注 <code>state</code> ,视图中的组件只关注展示数据和触发事件， Actions 只关注 <code>state</code> 的变化和其内部的数据。 Reducers 只关注融合旧的 <code>state</code> 和 actions 到新的 <code>state</code> 。当你阅读器源代码并理解它时，你会发现一切都是模块化，优雅和具有明确目的的。</p>
<p>Flux 有一些其他的好处：</p>
<ul>
<li>Actions 是触发 <code>state</code> 改变的唯一方式，且该过程不经过 UI 组件，并且因为 Reducer ，让其很有秩序，远离竞争。</li>
<li><code>state</code> 变得不可变，并且有一系列的 <code>state</code> 。每一个都因为代一个独特的变化而被创建。这让你在应用程序中能更简单和清晰的追踪 <code>state</code> 的状态。</li>
</ul>
<p>##将它们融合在一起</p>
<p>所以现在，我们已经讨论完抽象的数据流，现在让我们来看看我们的 React Native 应用如何使用它们，以及在这个过程中我们学到的东西。</p>
<h3 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h3><p><a href="http://redux.js.org/docs/basics/Store.html" target="_blank" rel="external">Redux 文档</a> 非常好的解释了如何创建简单的 Store,所以我们将会将设您已经阅读那里的基本知识，并跳过一点点内容，包括 Store 的几个额外参数。</p>
<h4 id="Store-的离线同步"><a href="#Store-的离线同步" class="headerlink" title="Store 的离线同步"></a>Store 的离线同步</h4><p>我们讨论过本地离线存储的必需性，这样应用程序才可以在低信号或无信号条件下工作（在技术会议上尤为重要）。幸运的是，因为我们正在使用 Redux，在我们的 app 中我们可以使用一些很简单的模块，其被叫做 <a href="https://www.npmjs.com/package/redux-persist" target="_blank" rel="external">Redux Persist</a> 。</p>
<p>在我们的 Store 中我们也会用到 <a href="http://redux.js.org/docs/advanced/Middleware.html" target="_blank" rel="external">中间件</a> ,我们将更多地讨论一些在测试阶段我们用的一些东西。但是总的来说，中间件让你能够在 Action 被分发和到达 Reducer 之前添加一些额外的逻辑操作（这对日志，崩溃报告，异步 APIs 等很有帮助）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* js/store/configureStore.js */</span></div><div class="line"><span class="keyword">var</span> createF8Store = applyMiddleware(...)(createStore);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">configureStore</span>(<span class="params">onComplete: ?(</span>) =&gt; <span class="title">void</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> store = autoRehydrate()(createF8Store)(reducers);</div><div class="line">  persistStore(store, &#123;<span class="attr">storage</span>: AsyncStorage&#125;, onComplete);</div><div class="line">  ...</div><div class="line">  return store;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这里，嵌套函数的语法可能有些让人迷惑（其中的一些函数返回将另一个函数作为参数），所以在这里扩展下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* js/store/configureStore.js */</span></div><div class="line"></div><div class="line"><span class="comment">// 1</span></div><div class="line"><span class="keyword">var</span> middlewareWrapper = applyMiddleware(...);</div><div class="line"><span class="comment">// 2</span></div><div class="line"><span class="keyword">var</span> createF8Store = middlewareWrapper(createStore(reducers));</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">configureStore</span>(<span class="params">onComplete: ?(</span>) =&gt; <span class="title">void</span>) </span>&#123;</div><div class="line">  <span class="comment">// 3</span></div><div class="line">  <span class="keyword">const</span> rehydrator = autoRehydrate();</div><div class="line">  <span class="keyword">const</span> store = rehydrator(createF8Store);</div><div class="line">  <span class="comment">// 4</span></div><div class="line">  persistStore(store, &#123;<span class="attr">storage</span>: AsyncStorage&#125;, onComplete);</div><div class="line">  ...</div><div class="line">  return store;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在第一行代码中，我们使用 Redux 的 appluMiddleware() 启动中间件（如果你想知道更多，请阅读 <a href="http://redux.js.org/docs/api/applyMiddleware.html" target="_blank" rel="external">Redux appluMiddleware 文档</a> 该函数用于实例 Store 对象）。</p>
<p>所以在第二行代码中，我们我们将 Redux的 createStore() 方法包裹在了 middlewareWrapper . createStore() 方法返回一个 Store 对象 ，middlewareWrapper() 通过中间件扩展它，最终结果保存在 createF8Store 中。</p>
<p>然后我们配置我们的 Store 对象。 Persist’s autoRehydrate() 是另外一个扩展 Store方法（和 applyMiddleware() 一样，其返回一个函数），我们更新现有的 Store 对象（第三行代码）。 autoRehydrate() 方法事先将一个 Store 对象保存到本地，然后根据 <code>state</code> 自动更新其状态。</p>
<p>第四行的 Persist package’s persistStore() （我们使用到了 React Native 的 <a href="https://facebook.github.io/react-native/docs/asyncstorage.html" target="_blank" rel="external">异步存储系统</a>） 函数是实际的将 app 的 Store 存储到本地。 autoRehydrate() 和 persistStore()  函数就是我们需要离线同步功能的全部代码。</p>
<p>现在，不管何时应用程序断开网络连接，Store 最近的副本依然会被存储到本地（包括通过 API 来抓取解析的数据），从用户角度来看，我们的应用仍然可以正常工作。<br>关于更多信息，你可以阅读 <a href="https://www.npmjs.com/package/redux-persist#basic-usage" target="_blank" rel="external">technical details of how the Redux Persist package works</a> ,但本质上我们已经完成了构建我们的 Store 。</p>
<h2 id="Reduers"><a href="#Reduers" class="headerlink" title="Reduers"></a>Reduers</h2><p>在上一节，我们解释了 Redux ,我们也因此引入了一个 Reducer 对象。然而在每个应用中，会有很多个 Reducers 对象。每个对象都对应着 <code>state</code> 的不同部分。举个例子，在一个可评论的应用中，你可能需要一个 reducer 关联到登录状态，其他的关联到其他的评论数据。</p>
<p>在 F8 应用中，我们将 reducers 存储在 js/reducers 中。这是 user.js 的简写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* js/reducers/user.js */</span></div><div class="line">...</div><div class="line">import type &#123;Action&#125; <span class="keyword">from</span> <span class="string">'../actions/types'</span>;</div><div class="line">...</div><div class="line"></div><div class="line"><span class="comment">// 1</span></div><div class="line"><span class="keyword">const</span> initialState = &#123;</div><div class="line">  <span class="attr">isLoggedIn</span>: <span class="literal">false</span>,</div><div class="line">  <span class="attr">hasSkippedLogin</span>: <span class="literal">false</span>,</div><div class="line">  <span class="attr">sharedSchedule</span>: <span class="literal">null</span>,</div><div class="line">  <span class="attr">id</span>: <span class="literal">null</span>,</div><div class="line">  <span class="attr">name</span>: <span class="literal">null</span>,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 2</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">user</span>(<span class="params">state: State = initialState, action: Action</span>): <span class="title">State</span> </span>&#123;</div><div class="line">  <span class="comment">// 3</span></div><div class="line">  <span class="keyword">if</span> (action.type === <span class="string">'LOGGED_IN'</span>) &#123;</div><div class="line">    <span class="comment">// 6</span></div><div class="line">    <span class="keyword">let</span> &#123;id, name, sharedSchedule&#125; = action.data;</div><div class="line">    <span class="keyword">if</span> (sharedSchedule === <span class="literal">undefined</span>) &#123;</div><div class="line">      sharedSchedule = <span class="literal">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      <span class="attr">isLoggedIn</span>: <span class="literal">true</span>,</div><div class="line">      <span class="attr">hasSkippedLogin</span>: <span class="literal">false</span>,</div><div class="line">      sharedSchedule,</div><div class="line">      id,</div><div class="line">      name,</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (action.type === <span class="string">'SKIPPED_LOGIN'</span>) &#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      <span class="attr">isLoggedIn</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">hasSkippedLogin</span>: <span class="literal">true</span>,</div><div class="line">      <span class="attr">sharedSchedule</span>: <span class="literal">null</span>,</div><div class="line">      <span class="attr">id</span>: <span class="literal">null</span>,</div><div class="line">      <span class="attr">name</span>: <span class="literal">null</span>,</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 4</span></div><div class="line">  <span class="keyword">if</span> (action.type === <span class="string">'LOGGED_OUT'</span>) &#123;</div><div class="line">    <span class="keyword">return</span> initialState;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 5</span></div><div class="line">  <span class="keyword">if</span> (action.type === <span class="string">'SET_SHARING'</span>) &#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      ...state,</div><div class="line">      <span class="attr">sharedSchedule</span>: action.enabled,</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (action.type === <span class="string">'RESET_NUXES'</span>) &#123;</div><div class="line">    <span class="keyword">return</span> &#123;...state, <span class="attr">sharedSchedule</span>: <span class="literal">null</span>&#125;;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> state;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = user;</div></pre></td></tr></table></figure>
<p>正如你所知， 这个 reducer 包含了 登录/登出 操作，以及特定的用户参数修改。让我们一点一点分析。</p>
<p>注意：在第六段，我们使用了 ES2015 的 destructuring assignment ，其将左边的变量分配给 <code>action.data</code></p>
<ol>
<li>初始状态</li>
</ol>
<p>在我们定义初始状态之前，这符合流动式命名习惯（我们将会在 React Native 应用的测试中详细解释）。 <code>initialState</code> 定义了 <code>state</code> 的一部分值，该值被 Reducer 处理，应用会首次加载它或者以前在其上的任何同步存储。</p>
<ol>
<li>Reducer 方法</li>
</ol>
<p>然后，我们编写 Reducer 的实例，其实相对来说还是很简单。 <code>state</code> 和 Action (之后我们会讨论) 被作为参数， <code>initialState</code> 作为 <code>state</code> 的默认值（我们将参数使用流式类型注解，同样的，我们会在 React Native 应用的测试部分提到）。然后，我们使用接收到的 Action ,具体为 ‘type’ 标签，返回一个新的改变了的 <code>state</code> 。</p>
<p>举个例子，如果第四段的 <code>LOGGED_OUT</code> Action 被分派（由于用户点击了登出按钮），我们将会重置 <code>state</code> 的一部分值为 <code>initialState</code> 。 如果第三段  <code>LOGGED_IN</code> Action 发生，你会看到应用将会使用余下数据，返回新的 <code>state</code> ，该 <code>state</code> 和 常规变化例如 <code>isLoggedIn</code>,或者用户输入数据变化 例如 <code>name</code> 都将冲突。</p>
<p>还有个方法我们也可以看下，这便是第五段的 <code>SET_SHARING</code> Action 类型。 其非常有趣因为 <code>...state</code> 注解被使用。在 React 中，注解让对象的分配更具兼容性和可读性，并且其会创建一个对象，然后拷贝已经存在的 <code>state</code> ,最后单独更新 <code>sharedSchedule</code> 的值。</p>
<p>你可以看到 Reducer 的结构是如此的简单和可读 - 定义一个 <code>initialState</code> ，构建一个传入 <code>state</code> 和 Action ,返回一个新的 <code>state</code> 的函数。</p>
<p>reducers 还有一个大的规则，我们引用 <a href="http://redux.js.org/docs/basics/Reducers.html#handling-actions" target="_blank" rel="external">Redux 文档</a>的内容：</p>
<blockquote>
<p>“记住，reducer 必须是单纯的。提供相同的参数，其应该计算下一个状态然后返回它。没有意外，没有副作用，没有 API 调用，没有突变，只有计算。”</p>
</blockquote>
<p>另外一件事需要注意的是：看看 <code>js/reducers/notifications.js</code> ,其有针对 <code>LOGGED_OUT</code> 动作类型的另一个引用。我们之前提到过，但是现在依然需要重复下 - 每一个 reducer 通常是在一个动作被派发后被调用，所以多个 reducers 可能会基于相同的动作来更新不同的 <code>state</code> 。</p>
<ul>
<li>Actions</li>
</ul>
<p>让我们仔细看下登录相关的动作，看看它们的代码位置：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/actions/login.js */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">skipLogin</span>(<span class="params"></span>): <span class="title">Action</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">type</span>: <span class="string">'SKIPPED_LOGIN'</span>,</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这是一个简单的Action creator (这个 creator 函数返回的对象实际上是一个 Action)，但是这让你看到了最基本的结构 - 每个动作可以简单的视为一个包含了 <code>type</code> 标签的对象。然后 reducers 可以使用该 <code>type</code> 来更新 <code>state</code> 。</p>
<p>同样，我们可以为 <code>type</code> 添加一些数据：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/actions/filter.js */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyTopicsFilter</span>(<span class="params">topics</span>): <span class="title">Action</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">type</span>: <span class="string">'APPLY_TOPICS_FILTER'</span>,</div><div class="line">    topics,</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这儿，动作创造者接收了一个参数，并且将其插入到了动作对象中。</p>
<p>然后，我们有一些动作制造者会执行额外的逻辑以及返回 Action 对象。在这个例子中，我们也会使用到一个叫做 ThunkAction 的 动作（<a href="http://redux.js.org/docs/recipes/ReducingBoilerplate.html" target="_blank" rel="external">Redux 建议你创建点类似这样的东西来减少模板</a>） - 这种特殊类型的动作制造者返回的是一个函数而不是一个动作。在这种情况下，登出动作制造者返回一个执行一些登出相关的逻辑函数，然后分配到一个 Action 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/actions/login.js */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">logOut</span>(<span class="params"></span>): <span class="title">ThunkAction</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</div><div class="line">    Parse.User.logOut();</div><div class="line">    FacebookSDK.logout();</div><div class="line">    ...</div><div class="line"></div><div class="line">    return dispatch(&#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'LOGGED_OUT'</span>,</div><div class="line">    &#125;);</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(注意，在这个例子中，我们也会使用到 <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Functions/Arrow_functions" target="_blank" rel="external">Arrow function</a> 语法)</p>
<h3 id="异步动作"><a href="#异步动作" class="headerlink" title="异步动作"></a>异步动作</h3><p>举个例子，如果你同任何 APIs 交互，你需要一些异步的动作制造者。 Redux 在这方面有个相当复杂的方式来实现异步，但是由于我们在使用 React Native , 我们可以使用到 ES7 的 <code>await</code> 函数，这极大简化了异步过程：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/actions/config.js */</span></div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">loadConfig</span>(<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">Action</span>&gt; </span>&#123;</div><div class="line">  <span class="keyword">const</span> config = <span class="keyword">await</span> Parse.Config.get();</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">type</span>: <span class="string">'LOADED_CONFIG'</span>,</div><div class="line">    config,</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这里，我们使用 一个 API 调用去解析去抓取一些应用程序的配置参数。任何像这样的 API 调用获取网络资源都需要耗费一定的时间。动作不会被立即分配，动作创造者首先等待 API 调用的结果，然后一旦数据有效，动作对象（负载着 API 数据）会被立即返回。</p>
<p>其异步调用的一个好处是，由于我们在等待 Parse.Config 调用的结果，其他的异步操作可以做其自己的工作，这样我们可以同时又多个操作，其会自动提高效率。</p>
<h2 id="绑定到组件"><a href="#绑定到组件" class="headerlink" title="绑定到组件"></a>绑定到组件</h2><p>现在，在我们应用的 setup 函数中链接 Redux 逻辑到 React ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/setup.js */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span>(<span class="params"></span>): <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  <span class="comment">// ... other setup logic</span></div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Root</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>() &#123;</div><div class="line">      <span class="keyword">super</span>();</div><div class="line">      <span class="keyword">this</span>.state = &#123;</div><div class="line">        <span class="attr">isLoading</span>: <span class="literal">true</span>,</div><div class="line">        <span class="attr">store</span>: configureStore(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.setState(&#123;<span class="attr">isLoading</span>: <span class="literal">false</span>&#125;)),</div><div class="line">      &#125;;</div><div class="line">    &#125;</div><div class="line">    render() &#123;</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.state.isLoading) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> (</div><div class="line">        <span class="comment">// 1</span></div><div class="line">        &lt;Provider store=&#123;<span class="keyword">this</span>.state.store&#125;&gt;</div><div class="line">          <span class="xml"><span class="tag">&lt;<span class="name">F8App</span> /&gt;</span></span></div><div class="line">        <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></div><div class="line">      );</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> Root;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们使用官方的 <a href="https://github.com/reactjs/react-redux" target="_blank" rel="external">React 和 Redux 绑定</a>, 因此我们可以使用 <a href="http://redux.js.org/docs/basics/UsageWithReact.html#passing-the-store" target="_blank" rel="external"><provider> 组件</provider></a> 。 这个 Provider 让我们的 Store 可以和任何我们创建的组件通信：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/F8App.js */</span></div><div class="line"><span class="keyword">var</span> F8App = React.createClass(&#123;</div><div class="line">  ...</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">// 1</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params">state</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">notifications</span>: state.notifications,</div><div class="line">    <span class="attr">isLoggedIn</span>: state.user.isLoggedIn || state.user.hasSkippedLogin,</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 2</span></div><div class="line"><span class="built_in">module</span>.exports = connect(select)(F8App);</div></pre></td></tr></table></figure>
<p>在上面，我们展示了一部分 <f8app> 组件的代码 - 我们整个应用的父组件。</f8app></p>
<p>上面第一个方被用来获取 Redux Store，然后从中获取一些数据，针对我们的 <code>&lt;F8App&gt;</code> 组件插入到 <code>props</code>。在这种情况下，我们希望通知的数据和用户登录状态的数据成为组件的 <code>props</code>，这样其会根据每一次 Store 的改变而更新状态。</p>
<p>我们可以使用 React-Redux 的 <a href="https://github.com/reactjs/react-redux/blob/master/docs/api.md#connectmapstatetoprops-mapdispatchtoprops-mergeprops-options" target="_blank" rel="external"><code>connect()</code> 方法</a>来实现它 - <code>connect()</code> 有一个参数叫做 <a href="https://github.com/reactjs/react-redux/blob/master/docs/api.md#arguments" target="_blank" rel="external"><code>mapStateToProps</code></a>，其会负载一个方法，当一个 Store 更新，该方法就会被调用。</p>
<p>所以当我们应用的 Store 更新时，<code>select()</code> 将会和被作为参数的新 <code>state</code> 一起被调用。<code>select()</code>返回一个包含了我们想从新 <code>state</code>中获取的数据（自在这个例子中，是<code>notifications</code>和<code>isLoggedIn</code>）,然后 第二段的<code>connect()</code> 融合数据到  <code>&lt;F8App&gt;</code> 组件的 <code>props</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/F8App.js */</span></div><div class="line"><span class="keyword">var</span> F8App = React.createClass(&#123;</div><div class="line">  ...</div><div class="line">  componentDidMount: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 1</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.notifications.enabled &amp;&amp; !<span class="keyword">this</span>.props.notifications.registered) &#123;</div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">  &#125;,</div><div class="line">  ...</div><div class="line">&#125;)</div><div class="line"><span class="string">``</span><span class="string">`  </span></div><div class="line"></div><div class="line">现在我们有个 `&lt;F8App&gt;<span class="string">` 组件，当任何新的已经通过 `</span>select()<span class="string">` 方法订阅了的 `</span>state<span class="string">`数据，都会被更新，其可以通过我们的 props 访问。但是我们如何从一个组件里分派动作？</span></div><div class="line"></div><div class="line">### 从组件中分派动作</div><div class="line"></div><div class="line">为了知道我们如何连接动作到组件，让我们看看 `&lt;GeneralScheduleView&gt;<span class="string">` 相关部分：</span></div><div class="line"></div><div class="line">`<span class="string">``</span>javascript</div><div class="line"><span class="comment">/* from js/tabs/schedule/GeneralScheduleView.js */</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">GeneralScheduleView</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  props: Props;</div><div class="line"></div><div class="line">  <span class="keyword">constructor</span>(props) &#123;</div><div class="line">    <span class="keyword">super</span>(props);</div><div class="line">    <span class="keyword">this</span>.renderStickyHeader = <span class="keyword">this</span>.renderStickyHeader.bind(<span class="keyword">this</span>);</div><div class="line">    ...</div><div class="line">    this.switchDay = <span class="keyword">this</span>.switchDay.bind(<span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;ListContainer</div><div class="line">        title="Schedule"</div><div class="line">        backgroundImage=&#123;require('./img/schedule-background.png')&#125;</div><div class="line">        backgroundShift=&#123;this.props.day - 1&#125;</div><div class="line">        backgroundColor=&#123;'#5597B8'&#125;</div><div class="line">        data=&#123;this.props.data&#125;</div><div class="line">        renderStickyHeader=&#123;this.renderStickyHeader&#125;</div><div class="line">        ...</div><div class="line">      /&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">  renderStickyHeader() &#123;</div><div class="line">    return (</div><div class="line">      &lt;View&gt;</div><div class="line">        &lt;F8SegmentedControl</div><div class="line">          values=&#123;['Day 1', 'Day 2']&#125;</div><div class="line">          selectedIndex=&#123;this.props.day - 1&#125;</div><div class="line">          selectionColor="#51CDDA"</div><div class="line">          onChange=&#123;this.switchDay&#125;</div><div class="line">        /&gt;</div><div class="line">        ...</div><div class="line">      &lt;/View&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">  switchDay(page) &#123;</div><div class="line">    this.props.switchDay(page + 1);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 1</div><div class="line"></div><div class="line">module.exports = GeneralScheduleView;</div></pre></td></tr></table></figure>
<p>同样，这段代码已经为了便于学习很大程度上简化了，但是我们现在可以在第一段添加和修改一些代码来连接这个 容器组件到 Redux store：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/tabs/schedule/GeneralScheduleView.js */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params">store</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">day</span>: store.navigation.day,</div><div class="line">    <span class="attr">data</span>: data(store),</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">actions</span>(<span class="params">dispatch</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">switchDay</span>: <span class="function">(<span class="params">day</span>) =&gt;</span> dispatch(switchDay(day)),</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = connect(select, actions)(GeneralScheduleView);</div></pre></td></tr></table></figure>
<p>这一次有一些不同 - 我们提供了 React-Redux 的 <code>connect()</code> 方法。总的来说，执行 <code>actions()</code> 内部的动作创造者到组件的 props,然后将其包裹在 <code>dispatch()</code>方法，这样它们才能立即分发一个 Action 。</p>
<h3 id="如何工作"><a href="#如何工作" class="headerlink" title="如何工作"></a>如何工作</h3><p>让我们看看实际的组件:</p>
<p>![](<a href="http://makeitopen.com/static/images/redux_flowchart.png）" target="_blank" rel="external">http://makeitopen.com/static/images/redux_flowchart.png）</a></p>
<p>  利用 ’Day 1’ 在 <code>renderStickyHeader()</code> 中触发 <code>onChange</code> 事件，然后在组件内部的 <code>switchDay()</code> 方法被调用，该方法分发 <code>this.props.switchDay()</code> 动作创造者。在我们的动作文件内，我们可以看到这样一个动作创造者：</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/actions/index.js */</span></div><div class="line">switchDay: (day): <span class="function"><span class="params">Action</span> =&gt;</span> (&#123;</div><div class="line">  <span class="attr">type</span>: <span class="string">'SWITCH_DAY'</span>,</div><div class="line">  day,</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>在导航 Reducer 内部，我们可以看到一个修改的 <code>day</code> 值产生一个新的 <code>state</code> 树：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/reducers/navigation.js */</span></div><div class="line">  <span class="keyword">if</span> (action.type === <span class="string">'SWITCH_DAY'</span>) &#123;</div><div class="line">    <span class="keyword">return</span> &#123;...state, <span class="attr">day</span>: action.day&#125;;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>这个 Reducer（以及任何其他那些可能监视 <code>SWITCH_DAY</code> 动作的 Reducers ）返回新的 <code>state</code> 到 Store中，其更新自己并且发送一个改变事件。</p>
<p>而由于通过连接 <code>&lt;GeneralScheduleView&gt;</code> 连接到 Redux Store,我们还订阅了 Store 的变化状态。</p>
<h2 id="什么是解析服务器"><a href="#什么是解析服务器" class="headerlink" title="什么是解析服务器"></a>什么是解析服务器</h2><p>在这个教程中，你希望你能够获取到大量新的信息，所以让我们快速展示我们如何连接 React Native 应用到我们的解析服务器数据后端，以及相关 API:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Parse.initialize(</div><div class="line">    <span class="string">'PARSE_APP_ID'</span>,</div><div class="line">    <span class="string">'PARSE_JAVASCRIPT_KEY'</span></div><div class="line">  );</div><div class="line">  Parse.serverURL = <span class="string">'http://exampleparseserver.com:1337/parse'</span></div></pre></td></tr></table></figure>
<p>就这样，在 React Native 中我们通过 解析 API 建立连接。</p>
<p>是的，因为我们现在使用的是 <a href="https://github.com/ParsePlatform/ParseReact" target="_blank" rel="external">Parse + React</a> SDK ,我们有非常简单的SDK接入。</p>
<h3 id="解析和动作"><a href="#解析和动作" class="headerlink" title="解析和动作"></a>解析和动作</h3><p>当然，我们希望能够查询（例如，在我们的Actions中）……很多的查询。对于那些动作创造者来说没什么特别的，它们是我们之前提到的相同的异步操作。然而，因为有非常多的简单的 Parse API 查询需要初始化应用，我们想大量减少样板。在我们的基本动作文件中，我们创建基本的动作构建者：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/actions/index.js */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadParseQuery</span>(<span class="params">type: string, query: Parse.Query</span>): <span class="title">ThunkAction</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> query.find(&#123;</div><div class="line">      <span class="attr">success</span>: <span class="function">(<span class="params">list</span>) =&gt;</span> dispatch((&#123;type, list&#125;: any)),</div><div class="line">      <span class="attr">error</span>: logError,</div><div class="line">    &#125;);</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后我们就可以简单的多次复用该代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">loadMaps: (): ThunkAction =&gt;</div><div class="line">  loadParseQuery(<span class="string">'LOADED_MAPS'</span>, <span class="keyword">new</span> Parse.Query(Maps)),</div></pre></td></tr></table></figure>
<p><code>loadMaps()</code> 变成了一个动作创建器，其将会运行一个简单的解析查询针对所有存储的地图数据，然后将其单独传递当查询结束时。<code>loadMaps()</code> 以及其他解析数据操作的动作可以在整个应用的 <code>componentDidMount（）</code> 方法中找到，这意味着当应用第一次打开时，其需要拉去所有的解析数据。</p>
<h3 id="解析和-Reducers"><a href="#解析和-Reducers" class="headerlink" title="解析和 Reducers"></a>解析和 Reducers</h3><p>我们已经减少了重复的动作，但是同时我们也想减少在我们 Reducers 内部的模板。这些模板将会从 动作负载中收到一些解析 API 的数据，并且必须将其映射到 <code>state</code>。我们针对解析数据创建单个基本 Reducer ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/reducers/createParseReducer.js */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createParseReducer</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></div><div class="line">  type: string,</div><div class="line">  convert: Convert&lt;T&gt;</div><div class="line">): <span class="title">Reducer</span>&lt;<span class="title">T</span>&gt; &#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">state: ?Array&lt;T&gt;, action: Action</span>): <span class="title">Array</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">if</span> (action.type === type) &#123;</div><div class="line">      <span class="comment">// Flow can't guarantee &#123;type, list&#125; is a valid action</span></div><div class="line">      <span class="keyword">return</span> (action: any).list.map(convert);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> state || [];</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这是个简单的 Reducer (有大量流式类型注解)，但是让我们看看其如何同基于关闭它的子 Reducers工作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/reducers/faqs.js */</span></div><div class="line"><span class="keyword">const</span> createParseReducer = <span class="built_in">require</span>(<span class="string">'./createParseReducer'</span>);</div><div class="line"></div><div class="line"><span class="keyword">export</span> type FAQ = &#123;</div><div class="line">  <span class="attr">id</span>: string;</div><div class="line">  question: string;</div><div class="line">  answer: string;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">fromParseObject</span>(<span class="params">map: Object</span>): <span class="title">FAQ</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">id</span>: map.id,</div><div class="line">    <span class="attr">question</span>: map.get(<span class="string">'question'</span>),</div><div class="line">    <span class="attr">answer</span>: map.get(<span class="string">'answer'</span>),</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = createParseReducer(<span class="string">'LOADED_FAQS'</span>, fromParseObject);</div></pre></td></tr></table></figure>
<p>所以不用每次去重复创建一份 <code>createParseReducer</code> 代码，我们只需要简单的传递一个对象给基本的 Reducer<br>，其会将 API 数据映射到我们的 <code>state</code> 上。</p>
<p>现在，我们的应用，拥有一个结构良好且易于理解的数据流，可以连接到我们的解析服务器，甚至能够离线同步我们的 Store 到本地存储。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/03/构建F8-App-part2/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Shaopei Bian">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="VeritasAmat-泠泠御风">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="VeritasAmat-泠泠御风" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/03/构建F8-App-part2/" itemprop="url">
                  构建F8-App part2
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-03T19:03:01+08:00">
                2016-06-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ReactNative/" itemprop="url" rel="index">
                    <span itemprop="name">ReactNative</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/06/03/构建F8-App-part2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/03/构建F8-App-part2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/06/03/构建F8-App-part2/" class="leancloud_visitors" data-flag-title="构建F8-App part2">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>React Native 的一大优势是：可以只用一种语法编写分别运行在 iOS 和 Android 平台上的程序，且可重用部分应用逻辑。然而，与“一次编写，到处运行”的理念不同的是，React Native 的哲学是“一次学习，到处编写”。如此一来，即使用 React Native 编写不同平台的程序，也可以尽可能贴合每个平台的特性。从 UI 的角度来看，每个平台都有自己独特的视觉风格、UI 范例甚或是技术层面的功能，那我们设计出一个统一的 UI 基础组件，然后再按照各平台特性进行调整岂不乐乎？</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>在后续的所有教程中，我们会仔细解读 App 的源代码，请克隆一份<a href="https://github.com/fbsamples/f8app" target="_blank" rel="external">源代码</a>到本地可访问的路径，然后根据<a href="http://makeitopen.com/tutorials/building-the-f8-app/local-setup/" target="_blank" rel="external">配置说明</a>在本地运行 App。在本章的教程中，你只需要阅读相关源代码。</p>
<h1 id="React-Native-思维模式"><a href="#React-Native-思维模式" class="headerlink" title="React Native 思维模式"></a>React Native 思维模式</h1><p>在你写任何 React 代码之前，请认真思考这个至关重要的问题：<strong>如何才能尽可能多地重用代码？</strong></p>
<p>React Native 的理念是针对每个平台分而治之，代码重用的做法看起来与之相违背，好像我们就应该为每个平台定制其专属的视觉组件一样，但实际上我们仍需努力让每个平台上的代码尽可能多地统一。</p>
<p>构建一套 React Native 应用视觉组件的关键点在于如何最好地实现平台抽象。开发人员和设计师可以列出应用中需要重用的组件，例如按钮、容器、列表行，头部等等，只有在必要的时候才单独为每个平台设计特定的组件。</p>
<p>当然，有一些组件相对于其它组件而言更为复杂，我们先一起来看看 F8 应用中不同的组件有什么区别。</p>
<h1 id="各种各样的小组件"><a href="#各种各样的小组件" class="headerlink" title="各种各样的小组件"></a>各种各样的小组件</h1><p>请看 F8 应用的示例图：</p>
<p><img src="http://makeitopen.com/static/images/iOS%20vs%20Android%20Segmented%20Controls@3x.png" alt="iOS and Android Segmented Controls Comparison"></p>
<p>在 iOS 版本中，我们用 iOS 系统中很常见的圆角边框风格来切分 Tab 控制；在 Android 版本中，我们用下划线的风格来标示这个组件。而这两个控制组件的功能其实完全相同。<br>  所以，即使两者样式稍有不同，但是实现的功能相同，所以我们可以用同一套代码抽象此处的逻辑，从而可以尽可能多地重用代码。<br>我们针对像这样的小组件做了很多跨平台重用逻辑代码的案例，比如一个简单的文本按钮，在每个平台上我们都会设计不同的 hover 和 active 状态的样式，但是除开这些视觉上的细微的差异外，逻辑功能完全相同。所以我们总结了一个抽象 React Native 视觉组件的最佳实践方法：设计一套相同的逻辑代码，然后在控制语句中编写其余需要差异化的部分。</p>
<p>以下是这个组件的示例代码（来自 <code>&lt;F8SegmentedControl&gt;</code>）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/common/F8SegmentedControl.js */</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Segment</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  props: &#123;</div><div class="line">    <span class="attr">value</span>: string;</div><div class="line">    isSelected: boolean;</div><div class="line">    selectionColor: string;</div><div class="line">    onPress: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">render() &#123;</div><div class="line">    <span class="keyword">var</span> selectedButtonStyle;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.isSelected) &#123;</div><div class="line">      selectedButtonStyle = &#123; <span class="attr">borderColor</span>: <span class="keyword">this</span>.props.selectionColor &#125;;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> deselectedLabelStyle;</div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.props.isSelected &amp;&amp; Platform.OS === <span class="string">'android'</span>) &#123;</div><div class="line">      deselectedLabelStyle = styles.deselectedLabel;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> title = <span class="keyword">this</span>.props.value &amp;&amp; <span class="keyword">this</span>.props.value.toUpperCase();</div><div class="line"></div><div class="line">    <span class="keyword">var</span> accessibilityTraits = [<span class="string">'button'</span>];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.isSelected) &#123;</div><div class="line">      accessibilityTraits.push(<span class="string">'selected'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      <span class="xml"><span class="tag">&lt;<span class="name">TouchableOpacity</span></span></span></div><div class="line">        <span class="attr">accessibilityTraits</span>=<span class="string">&#123;accessibilityTraits&#125;</span></div><div class="line">        <span class="attr">activeOpacity</span>=<span class="string">&#123;0.8&#125;</span></div><div class="line">        <span class="attr">onPress</span>=<span class="string">&#123;this.props.onPress&#125;</span></div><div class="line">        <span class="attr">style</span>=<span class="string">&#123;[styles.button,</span> <span class="attr">selectedButtonStyle</span>]&#125;&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;[styles.label,</span> <span class="attr">deselectedLabelStyle</span>]&#125;&gt;</span></div><div class="line">          &#123;title&#125;</div><div class="line">        <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">TouchableOpacity</span>&gt;</span></div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这段代码中，我们为每一种平台分别应用了不同的样式（用到了 React Native 的 <a href="https://facebook.github.io/react-native/docs/platform-specific-code.html#platform-module" target="_blank" rel="external">Platform 模块</a>）。各平台中的 Tab 按钮都应用了相同的通用样式，同时也根据各平台特性定制了独占样式（同样出自 <code>&lt;F8SegmentedControl&gt;</code>）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/common/F8SegmentedControl.js */</span></div><div class="line"><span class="keyword">var</span> styles = F8StyleSheet.create(&#123;</div><div class="line">  <span class="attr">container</span>: &#123;</div><div class="line">    <span class="attr">flexDirection</span>: <span class="string">'row'</span>,</div><div class="line">    <span class="attr">backgroundColor</span>: <span class="string">'transparent'</span>,</div><div class="line">    <span class="attr">ios</span>: &#123;</div><div class="line">      <span class="attr">paddingBottom</span>: <span class="number">6</span>,</div><div class="line">      <span class="attr">justifyContent</span>: <span class="string">'center'</span>,</div><div class="line">      <span class="attr">alignItems</span>: <span class="string">'center'</span>,</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">android</span>: &#123;</div><div class="line">      <span class="attr">paddingLeft</span>: <span class="number">60</span>,</div><div class="line">    &#125;,</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">button</span>: &#123;</div><div class="line">    <span class="attr">borderColor</span>: <span class="string">'transparent'</span>,</div><div class="line">    <span class="attr">alignItems</span>: <span class="string">'center'</span>,</div><div class="line">    <span class="attr">justifyContent</span>: <span class="string">'center'</span>,</div><div class="line">    <span class="attr">backgroundColor</span>: <span class="string">'transparent'</span>,</div><div class="line">    <span class="attr">ios</span>: &#123;</div><div class="line">      <span class="attr">height</span>: HEIGHT,</div><div class="line">      <span class="attr">paddingHorizontal</span>: <span class="number">20</span>,</div><div class="line">      <span class="attr">borderRadius</span>: HEIGHT / <span class="number">2</span>,</div><div class="line">      <span class="attr">borderWidth</span>: <span class="number">1</span>,</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">android</span>: &#123;</div><div class="line">      <span class="attr">paddingBottom</span>: <span class="number">6</span>,</div><div class="line">      <span class="attr">paddingHorizontal</span>: <span class="number">10</span>,</div><div class="line">      <span class="attr">borderBottomWidth</span>: <span class="number">3</span>,</div><div class="line">      <span class="attr">marginRight</span>: <span class="number">10</span>,</div><div class="line">    &#125;,</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">label</span>: &#123;</div><div class="line">    <span class="attr">letterSpacing</span>: <span class="number">1</span>,</div><div class="line">    <span class="attr">fontSize</span>: <span class="number">12</span>,</div><div class="line">    <span class="attr">color</span>: <span class="string">'white'</span>,</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">deselectedLabel</span>: &#123;</div><div class="line">    <span class="attr">color</span>: <span class="string">'rgba(255, 255, 255, 0.7)'</span>,</div><div class="line">  &#125;,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在这段代码中我们使用了一个改编自 <a href="https://facebook.github.io/react-native/docs/stylesheet.html" target="_blank" rel="external">React Native <code>StyleSheet</code> API</a> 的函数 F8StyleSheet，它可以针对各平台分别进行样式转换操作：</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(styles: <span class="keyword">Object</span>)</span>:</span> <span class="comment">&#123;[name: string]: number&#125;</span> <span class="comment">&#123;</span></div><div class="line">  const platformStyles = &#123;&#125;;</div><div class="line">  <span class="keyword">Object</span>.keys(styles).forEach((<span class="keyword">name</span>) =&gt; <span class="comment">&#123;</span></div><div class="line">    let &#123;ios, android, ...style&#125; = <span class="comment">&#123;...styles[name]&#125;</span>;</div><div class="line">    <span class="keyword">if</span> (ios &amp;&amp; <span class="keyword">Platform</span>.OS === <span class="string">'ios'</span>) <span class="comment">&#123;</span></div><div class="line">      style = &#123;...style, ...ios&#125;;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (android &amp;&amp; <span class="keyword">Platform</span>.OS === <span class="string">'android'</span>) <span class="comment">&#123;</span></div><div class="line">      style = &#123;...style, ...android&#125;;</div><div class="line">    &#125;</div><div class="line">    platformStyles[<span class="keyword">name</span>] = style;</div><div class="line">  &#125;);</div><div class="line">  return StyleSheet.create(platformStyles);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这个 <code>F8StyleSheet</code> 函数中我们解析了前面示例代码中的 <code>styles</code> 对象，如果我们发现了匹配当前平台的 <code>ios</code> 或 <code>android</code> 键值，就会应用相应的样式，如果都没有，则应用默认样式。以此看来，减少代码重复的另一种做法是：尽可能多地重用通用样式代码。</p>
<p>现在，我们已经可以在我们的App中重用这个组件了，它也可以根据不同的平台自动匹配相应的样式。</p>
<h1 id="分离复杂差异"><a href="#分离复杂差异" class="headerlink" title="分离复杂差异"></a>分离复杂差异</h1><p>如果一个组件在各平台上的差异不仅仅是样式的不同，也存在大量的逻辑代码差异，那我们就需要换一种方式了。正如下图所示，iOS 和 Android 平台中最高阶的菜单导航组件就有非常大的差异：</p>
<p><img src="http://makeitopen.com/static/images/iOS%20vs.%20Android@3x.png" alt="iOS and Android Main Navigation Comparison"></p>
<p>正如你所见，在 iOS 版本中我们在屏幕底部放了一个固定的 Tab，而在 Android 版本中，我们却实现了一种可划出的侧边栏。这两种组件其实是本质上的不同，况且一般来说，在 Android 应用中，这种侧边栏通常还会包含更多的菜单选项，例如：退出登录。</p>
<p>你当然可以将这两种菜单模式写到一个组件中去，但是这个组件会变得异常臃肿，所有的差异不得不通过大量的分支语句来实现，你一定会在不久的将来对这段代码感到陌生难懂。</p>
<p>其实，我们可以用 React Native 内建的平台特定的扩展来解决这个问题。我们可以创建两个独立的应用，在下面的示例中我们会创建两个组件，分别命名为：<code>F8TabsView.ios.js</code> 和 <code>F8TabsView.android.js</code>。React Native 会自动检测当前平台并根据扩展命名加载相应的组件。</p>
<h1 id="内建UI组件"><a href="#内建UI组件" class="headerlink" title="内建UI组件"></a>内建UI组件</h1><p>在每一个 <code>FBTabsView</code> 组件中，我们也可以重用一些内建的 React Native UI 组件，Android 版本使用的是 <a href="http://facebook.github.io/react-native/docs/drawerlayoutandroid.html" target="_blank" rel="external"><code>DrawerLayoutAndroid</code></a>（很显然，只在 Android 中可用）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/tabs/F8TabsView.android.js */</span></div><div class="line">render() &#123;</div><div class="line">  <span class="keyword">return</span> (</div><div class="line">    <span class="xml"><span class="tag">&lt;<span class="name">DrawerLayoutAndroid</span></span></span></div><div class="line">      <span class="attr">ref</span>=<span class="string">"drawer"</span></div><div class="line">      <span class="attr">drawerWidth</span>=<span class="string">&#123;300&#125;</span></div><div class="line">      <span class="attr">drawerPosition</span>=<span class="string">&#123;DrawerLayoutAndroid.positions.Left&#125;</span></div><div class="line">      <span class="attr">renderNavigationView</span>=<span class="string">&#123;this.renderNavigationView&#125;</span>&gt;</div><div class="line">      <span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.content&#125;</span> <span class="attr">key</span>=<span class="string">&#123;this.props.activeTab&#125;</span>&gt;</span></div><div class="line">        &#123;this.renderContent()&#125;</div><div class="line">      <span class="tag">&lt;/<span class="name">View</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">DrawerLayoutAndroid</span>&gt;</span></div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在第8行代码中，我们在当前的类中显式地为 drawer 组件指定了 <code>renderNavigationView()</code> 函数。这个函数会返回 drawer 中渲染出来的内容。在这个示例中，我们渲染的是一个包含在自定义 <code>MenuItem</code> 组件(点击查看 <a href="https://github.com/fbsamples/f8app/blob/master/js/tabs/MenuItem.js" target="_blank" rel="external"><code>MenuItem.js</code></a>)中的 <a href="http://facebook.github.io/react-native/docs/scrollview.html" target="_blank" rel="external"><code>ScrollView</code></a> 组件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/tabs/F8TabsView.android.js */</span></div><div class="line">renderNavigationView() &#123;</div><div class="line">  ...</div><div class="line">  return(</div><div class="line">    &lt;ScrollView style=&#123;styles.drawer&#125;&gt;</div><div class="line">      &lt;MenuItem</div><div class="line">        title="Schedule"</div><div class="line">        selected=&#123;this.props.activeTab === 'schedule'&#125;</div><div class="line">        onPress=&#123;this.onTabSelect.bind(this, 'schedule')&#125;</div><div class="line">        icon=&#123;scheduleIcon&#125;</div><div class="line">        selectedIcon=&#123;scheduleIconSelected&#125;</div><div class="line">      /&gt;</div><div class="line">      &lt;MenuItem</div><div class="line">        title="My F8"</div><div class="line">        selected=&#123;this.props.activeTab === 'my-schedule'&#125;</div><div class="line">        onPress=&#123;this.onTabSelect.bind(this, 'my-schedule')&#125;</div><div class="line">        icon=&#123;require('./schedule/img/my-schedule-icon.png')&#125;</div><div class="line">        selectedIcon=&#123;require('./schedule/img/my-schedule-icon-active.png')&#125;</div><div class="line">      /&gt;</div><div class="line">      &lt;MenuItem</div><div class="line">        title="Map"</div><div class="line">        selected=&#123;this.props.activeTab === 'map'&#125;</div><div class="line">        onPress=&#123;this.onTabSelect.bind(this, 'map')&#125;</div><div class="line">        icon=&#123;require('./maps/img/maps-icon.png')&#125;</div><div class="line">        selectedIcon=&#123;require('./maps/img/maps-icon-active.png')&#125;</div><div class="line">      /&gt;</div><div class="line">      &lt;MenuItem</div><div class="line">        title="Notifications"</div><div class="line">        selected=&#123;this.props.activeTab === 'notifications'&#125;</div><div class="line">        onPress=&#123;this.onTabSelect.bind(this, 'notifications')&#125;</div><div class="line">        badge=&#123;this.state.notificationsBadge&#125;</div><div class="line">        icon=&#123;require('./notifications/img/notifications-icon.png')&#125;</div><div class="line">        selectedIcon=&#123;require('./notifications/img/notifications-icon-active.png')&#125;</div><div class="line">      /&gt;</div><div class="line">      &lt;MenuItem</div><div class="line">        title="Info"</div><div class="line">        selected=&#123;this.props.activeTab === 'info'&#125;</div><div class="line">        onPress=&#123;this.onTabSelect.bind(this, 'info')&#125;</div><div class="line">        icon=&#123;require('./info/img/info-icon.png')&#125;</div><div class="line">        selectedIcon=&#123;require('./info/img/info-icon-active.png')&#125;</div><div class="line">      /&gt;</div><div class="line">    &lt;/ScrollView&gt;</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>相比之下，iOS 版本直接在 <code>render()</code> 函数中使用了一个不同的内建组件，<a href="http://facebook.github.io/react-native/docs/tabbarios.html" target="_blank" rel="external"><code>TabBarIOS</code></a>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/tabs/F8TabsView.ios.js */</span></div><div class="line">render() &#123;</div><div class="line">  <span class="keyword">var</span> scheduleIcon = <span class="keyword">this</span>.props.day === <span class="number">1</span></div><div class="line">    ? <span class="built_in">require</span>(<span class="string">'./schedule/img/schedule-icon-1.png'</span>)</div><div class="line">    : <span class="built_in">require</span>(<span class="string">'./schedule/img/schedule-icon-2.png'</span>);</div><div class="line">  <span class="keyword">var</span> scheduleIconSelected = <span class="keyword">this</span>.props.day === <span class="number">1</span></div><div class="line">    ? <span class="built_in">require</span>(<span class="string">'./schedule/img/schedule-icon-1-active.png'</span>)</div><div class="line">    : <span class="built_in">require</span>(<span class="string">'./schedule/img/schedule-icon-2-active.png'</span>);</div><div class="line">  <span class="keyword">return</span> (</div><div class="line">    &lt;TabBarIOS tintColor=&#123;F8Colors.darkText&#125;&gt;</div><div class="line">      &lt;TabBarItemIOS</div><div class="line">        title="Schedule"</div><div class="line">        selected=&#123;this.props.activeTab === 'schedule'&#125;</div><div class="line">        onPress=&#123;this.onTabSelect.bind(this, 'schedule')&#125;</div><div class="line">        icon=&#123;scheduleIcon&#125;</div><div class="line">        selectedIcon=&#123;scheduleIconSelected&#125;&gt;</div><div class="line">        &lt;GeneralScheduleView</div><div class="line">          navigator=&#123;this.props.navigator&#125;</div><div class="line">          onDayChange=&#123;this.handleDayChange&#125;</div><div class="line">        /&gt;</div><div class="line">      &lt;/TabBarItemIOS&gt;</div><div class="line">      &lt;TabBarItemIOS</div><div class="line">        title="My F8"</div><div class="line">        selected=&#123;this.props.activeTab === 'my-schedule'&#125;</div><div class="line">        onPress=&#123;this.onTabSelect.bind(this, 'my-schedule')&#125;</div><div class="line">        icon=&#123;require('./schedule/img/my-schedule-icon.png')&#125;</div><div class="line">        selectedIcon=&#123;require('./schedule/img/my-schedule-icon-active.png')&#125;&gt;</div><div class="line">        &lt;MyScheduleView</div><div class="line">          navigator=&#123;this.props.navigator&#125;</div><div class="line">          onJumpToSchedule=&#123;() =&gt; this.props.onTabSelect('schedule')&#125;</div><div class="line">        /&gt;</div><div class="line">      &lt;/TabBarItemIOS&gt;</div><div class="line">      &lt;TabBarItemIOS</div><div class="line">        title="Map"</div><div class="line">        selected=&#123;this.props.activeTab === 'map'&#125;</div><div class="line">        onPress=&#123;this.onTabSelect.bind(this, 'map')&#125;</div><div class="line">        icon=&#123;require('./maps/img/maps-icon.png')&#125;</div><div class="line">        selectedIcon=&#123;require('./maps/img/maps-icon-active.png')&#125;&gt;</div><div class="line">        &lt;F8MapView /&gt;</div><div class="line">      &lt;/TabBarItemIOS&gt;</div><div class="line">      &lt;TabBarItemIOS</div><div class="line">        title="Notifications"</div><div class="line">        selected=&#123;this.props.activeTab === 'notifications'&#125;</div><div class="line">        onPress=&#123;this.onTabSelect.bind(this, 'notifications')&#125;</div><div class="line">        badge=&#123;this.state.notificationsBadge&#125;</div><div class="line">        icon=&#123;require('./notifications/img/notifications-icon.png')&#125;</div><div class="line">        selectedIcon=&#123;require('./notifications/img/notifications-icon-active.png')&#125;&gt;</div><div class="line">        &lt;F8NotificationsView navigator=&#123;this.props.navigator&#125; /&gt;</div><div class="line">      &lt;/TabBarItemIOS&gt;</div><div class="line">      &lt;TabBarItemIOS</div><div class="line">        title="Info"</div><div class="line">        selected=&#123;this.props.activeTab === 'info'&#125;</div><div class="line">        onPress=&#123;this.onTabSelect.bind(this, 'info')&#125;</div><div class="line">        icon=&#123;require('./info/img/info-icon.png')&#125;</div><div class="line">        selectedIcon=&#123;require('./info/img/info-icon-active.png')&#125;&gt;</div><div class="line">        &lt;F8InfoView navigator=&#123;this.props.navigator&#125; /&gt;</div><div class="line">      &lt;/TabBarItemIOS&gt;</div><div class="line">    &lt;/TabBarIOS&gt;</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>显而易见，尽管 iOS 菜单接受了相同的数据，但是它的结构略有不同。我们并没有用一个独立的函数创建菜单元素，而是将这些元素作为父级菜单的子元素插入进来，正如 <a href="http://facebook.github.io/react-native/docs/tabbarios-item.html#content" target="_blank" rel="external"><code>TabBarItemIOS</code></a> 组件这样。<br>这里的 <code>TabBarItem</code> 与 Android 中 的 <code>MenuItem</code> 本质上是相同的，唯一的区别是在 Android 组件中我们会定义一个独立的主 <a href="http://facebook.github.io/react-native/docs/view.html#content" target="_blank" rel="external"><code>View</code> 组件</a>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;View style=&#123;styles.content&#125; key=&#123;<span class="keyword">this</span>.props.activeTab&#125;&gt;</div><div class="line">  &#123;<span class="keyword">this</span>.renderContent()&#125;</div><div class="line">&lt;<span class="regexp">/View&gt;</span></div></pre></td></tr></table></figure>
<p>然后当一个 tab 改变时改变这个组件（通过 <code>renderContent()</code> 函数），而 iOS 组件则会有多个分离的 <code>View</code> 组件，例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;GeneralScheduleView</div><div class="line">  navigator=&#123;<span class="keyword">this</span>.props.navigator&#125;</div><div class="line">  onDayChange=&#123;<span class="keyword">this</span>.handleDayChange&#125;</div><div class="line">/&gt;</div></pre></td></tr></table></figure>
<p>这是 <code>TabBarItem</code> 的一部分，可以点击使它们可见。</p>
<h1 id="设计迭代周期"><a href="#设计迭代周期" class="headerlink" title="设计迭代周期"></a>设计迭代周期</h1><p>当你构建任何应用，无论是在移动平台还是 web 环境下，调整适配的 UI 元素是非常痛苦的。如果工程师和设计师共同协作，会使整个过程慢下来。</p>
<p>React Native 包含了一个<a href="http://facebook.github.io/react-native/docs/debugging.html#live-reload" target="_blank" rel="external">实时重载</a>的 debug 功能，可以当 JavaScript 改变时触发刷新应用。这可以在极大程度上减少设计迭代过程，一旦改变了组件样式并保存后，你会立即看到更新的样式。</p>
<p>但是如果组件在不同条件下看起来不同怎么办呢？举个例子，一个按钮组件可能有一个默认样式，也分别包含按下、执行任务中、执行任务完成时的样式。</p>
<p>为了避免每次都与应用交互，我们内建了一个用于 debug 视觉效果的 <code>Playgroud</code> 组件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/setup.js */</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Playground</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(props) &#123;</div><div class="line">    <span class="keyword">super</span>(props);</div><div class="line">    <span class="keyword">const</span> content = [];</div><div class="line">    <span class="keyword">const</span> define = <span class="function">(<span class="params">name: string, render: <span class="built_in">Function</span></span>) =&gt;</span> &#123;</div><div class="line">      content.push(<span class="xml"><span class="tag">&lt;<span class="name">Example</span> <span class="attr">key</span>=<span class="string">&#123;name&#125;</span> <span class="attr">render</span>=<span class="string">&#123;render&#125;</span> /&gt;</span>);</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    var AddToScheduleButton = require('./tabs/schedule/AddToScheduleButton');</div><div class="line">    AddToScheduleButton.__cards__(define);</div><div class="line">    this.state = &#123;content&#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  render() &#123;</div><div class="line">    return (</div><div class="line">      <span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=&gt;</span></div><div class="line">        &#123;this.state.content&#125;</div><div class="line">      <span class="tag">&lt;/<span class="name">View</span>&gt;</span></div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其实我们只是创建了一个可交换加载的空视图，将其与一些示例定义整合到其中一个 UI 组件中，正如下面这段 <code>AddToScheduleButton.js</code> 所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/tabs/schedule/AddToScheduleButton.js */</span></div><div class="line"><span class="built_in">module</span>.exports.__cards__ = <span class="function">(<span class="params">define</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">let</span> f;</div><div class="line">  setInterval(<span class="function"><span class="params">()</span> =&gt;</span> f &amp;&amp; f(), <span class="number">1000</span>);</div><div class="line"></div><div class="line">  define(<span class="string">'Inactive'</span>, (state = <span class="literal">true</span>, update) =&gt;</div><div class="line">    &lt;AddToScheduleButton isAdded=&#123;state&#125; onPress=&#123;() =&gt; update(!state)&#125; /&gt;);</div><div class="line"></div><div class="line">  define('Active', (state = false, update) =&gt;</div><div class="line">    &lt;AddToScheduleButton isAdded=&#123;state&#125; onPress=&#123;() =&gt; update(!state)&#125; /&gt;);</div><div class="line"></div><div class="line">  define('Animated', (state = false, update) =&gt; &#123;</div><div class="line">    f = () =&gt; update(!state);</div><div class="line">    return &lt;AddToScheduleButton isAdded=&#123;state&#125; /&gt;;</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>我们可以将这个应用转化为一个 UI 预览工具：</p>
<p><img src="http://makeitopen.com/static/images/button-playground.gif" alt="UI preview playground in action with a button and three different states"></p>
<p>在这个示例中为这个按钮定义了按下和抬起两种状态，第三个按钮在这两者的状态之间不断循环，以此来预览过渡的动画效果。</p>
<p>现在，我们可以跟设计师一起快速调整基础组件的视觉样式了。</p>
<p>如果想用这个功能，<code>&lt;Playground&gt;</code> 组件必须在任何 React Native 应用中都可用，我们需要在 <code>setup()</code> 函数中交换一些代码来加载 <code>&lt;Playground&gt;</code> 组件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* from js/setup.js */</span></div><div class="line">render() &#123;</div><div class="line">  ...</div><div class="line">  return (</div><div class="line">    <span class="xml"><span class="tag">&lt;<span class="name">Provider</span> <span class="attr">store</span>=<span class="string">&#123;this.state.store&#125;</span>&gt;</span></span></div><div class="line">      <span class="tag">&lt;<span class="name">F8App</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>变为</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* in js/setup.js */</span></div><div class="line">render() &#123;</div><div class="line">  ...</div><div class="line">  return (</div><div class="line">    <span class="xml"><span class="tag">&lt;<span class="name">Provider</span> <span class="attr">store</span>=<span class="string">&#123;this.state.store&#125;</span>&gt;</span></span></div><div class="line">      <span class="tag">&lt;<span class="name">Playground</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，你也可以修改 <code>&lt;Playground&gt;</code> 组件，使其能够改变引入的其它组件。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/05/28/构建F8-App-part1/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Shaopei Bian">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="VeritasAmat-泠泠御风">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="VeritasAmat-泠泠御风" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/28/构建F8-App-part1/" itemprop="url">
                  构建F8-App part1
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-05-28T18:51:40+08:00">
                2016-05-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ReactNative/" itemprop="url" rel="index">
                    <span itemprop="name">ReactNative</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/05/28/构建F8-App-part1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/28/构建F8-App-part1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/05/28/构建F8-App-part1/" class="leancloud_visitors" data-flag-title="构建F8-App part1">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在第一部分，我们将介绍我们是如何计划的，在后面的部分，我们将分享示例代码，讨论多平台设计需要考虑的事情，分析应用的数据层，最后解释我们所选择的测试策略。</p>
<h2 id="使用-React-Native"><a href="#使用-React-Native" class="headerlink" title="使用 React Native"></a>使用 React Native</h2><p>在 2015 年的 F8 大会，我们使用 React Native 开发了官方应用的 iOS 版，但 Android 版使用的是原生代码；在更早的大会上，我们在两个平台使用的都是原生代码。去年大会之后，React Native 发布了 Android 版本，这给我们提供了机会来削减应用的逻辑和 UI 代码。部分 Facebook 团队在使用 React Native 时发现<a href="https://code.facebook.com/posts/1189117404435352/react-native-for-android-how-we-built-the-first-cross-platform-react-native-app/" target="_blank" rel="external">达到了 85% 的代码共用</a>。</p>
<p>React Native 在原型设计方面也有优势，它可以在你和 UI 设计师讨论的时候快速构建视觉组件原型，这些我们将在<a href="">第二部分</a>讨论。</p>
<p>所以，如果我们选择使用 React Native，还有什么需要考虑的？让我们先从内容开始。</p>
<h2 id="选择一个数据层"><a href="#选择一个数据层" class="headerlink" title="选择一个数据层"></a>选择一个数据层</h2><p>2014 和 15 年的 F8 应用都使用了<a href="https://parse.com/" target="_blank" rel="external">Parse</a>作为数据后端。因此，在我们计划开发 2016 年的应用时，使用 Parse 将允许我们重用现有的数据结构，以及能够快速开发开发。</p>
<p>选择 Parse 也有其它的原因 - 从大会准备到举办的期间，应用所展现的内容需要经常更新，并且内容更新应该像更新表格一样容易，而不需要工程师来协助。Parse 提供的 dashboard 能完美的满足这些需求。</p>
<p>由于以上原因，选择 Parse 作为后端顺理成章。不过，由于 <a href="http://blog.parse.com/announcements/moving-on/" target="_blank" rel="external">Parse 宣布将停止服务</a>，我们转而使用开源的 <a href="http://blog.parse.com/announcements/introducing-parse-server-and-the-database-migration-tool/" target="_blank" rel="external">Parse Server</a> 和 <a href="https://github.com/ParsePlatform/parse-dashboard" target="_blank" rel="external">Parse Dashboard</a> 来替代它。</p>
<p>由于 React Native 并不需要时刻与数据层保持紧密连接，比如 UI 和应用逻辑能使用模拟数据完成开发。这意味着我们可以仅以极少的代价替换整个数据层。比如在开发完 F8 应用后，我们能够非常容易的从 Parse 转移到开源的 Parse Server，我们将在<a href="">第三部分</a>进一步讨论。</p>
<h2 id="React-Native-应用的数据接入"><a href="#React-Native-应用的数据接入" class="headerlink" title="React Native 应用的数据接入"></a>React Native 应用的数据接入</h2><p>为了让 Parse 和 React Native 协同工作，我们已经有了 <a href="https://github.com/ParsePlatform/ParseReact" target="_blank" rel="external">Parse + React Native package</a> 来提供必需的绑定工具，不过这里有一个问题 - 考虑到会场 wi-fi 和连通性并不总是表现良好，F8 应用需要支持离线工作。因为 Parse + React 并不提供离线数据同步功能，我们只能自己开发。</p>
<p>这里还有另一个决定因素 - 团队大小。比如，提供类似功能的 Relay 更适合大型团队开发大规模应用，但 F8 应用的开发者只有一个人，以及少数其它人提供设计支持。这将极大影响你在开发应用中使用的数据接入方法。</p>
<p>那么 <a href="http://graphql.org/" target="_blank" rel="external">GraphQL</a> 和 <a href="https://facebook.github.io/relay/" target="_blank" rel="external">Relay</a> 呢？虽然它们与 React Native 工作良好，但<a href="https://github.com/facebook/relay/wiki/Roadmap#in-progress" target="_blank" rel="external">目前为止</a>，Relay 不提供内建的离线使用，而 Parse 对 GraphQL 的支持并不完美。使用它们开发，我们需要构建 GraphQL 到 Parse 的 API，并且开发 Relay 的离线存储方法。</p>
<p>GraphQL 服务器的设置对于面临紧迫工期的个人来说也相对复杂。我需要开发应用并发布到应用商店，只能选择最简单并且最快的方式，除此之外我还能怎么做呢？</p>
<p>由于以上原因，<a href="https://github.com/rackt/redux" target="_blank" rel="external">Redux</a> 也是应用的一个最佳选择。Redux 提供了 <a href="https://facebook.github.io/flux/" target="_blank" rel="external">Flux 架构</a>的一个简单实现，对数据的存储和缓存提供更多控制，并最终让应用能从 Parse 进行单向同步。</p>
<p>对应用的存储部分，Redux 提供了功能性与易用性之间的平衡。在应用发布之后，我们重新梳理了这一部分，并且使用 Relay 和 GraphQL 实现了一遍，我们将在 <a href="http://makeitopen.com/tutorials/building-the-f8-app/relay/" target="_blank" rel="external">Relay 和 GraphQL 附加部分</a>讨论这些。</p>
<h2 id="我们的开发技术栈"><a href="#我们的开发技术栈" class="headerlink" title="我们的开发技术栈"></a>我们的开发技术栈</h2><p>将 React Native 作为我们的应用框架，以及 Redux 作为数据层，我们需要一些其它的支持技术和工具：</p>
<ul>
<li>开源的 <a href="https://github.com/ParsePlatform/parse-server" target="_blank" rel="external">Parse Server</a> 提供数据存储 - 运行在 <a href="https://nodejs.org/" target="_blank" rel="external">Node.js</a> 上。</li>
<li>我们使用了 <a href="http://flowtype.org/" target="_blank" rel="external">Flow</a> 来检查 React Native JavaScript 代码中的类型错误。</li>
<li><a href="http://facebook.github.io/jest/" target="_blank" rel="external">Jest framework</a> 用来对复杂的函数进行单元测试。</li>
<li>使用 <a href="https://github.com/facebook/react-native-fbsdk" target="_blank" rel="external">React Native Facebook SDK</a> 来快速集成 Facebook 接入功能。</li>
<li>使用 OSX 平台的 <a href="http://nuclide.io/" target="_blank" rel="external">Nuclide</a> 编辑器，以及它<a href="http://nuclide.io/docs/platforms/react-native/" target="_blank" rel="external">内建的 React Native 支持</a>。</li>
<li>我们还使用 Git 做版本管理，将开发的过程都存储到了 <a href="https://github.com/fbsamples/f8app" target="_blank" rel="external">Github</a> 上。</li>
</ul>
<p>我们还使用了一些小的附加工具包，当我们在教程中碰到时会重点提到。</p>
<p>在你阅读系列教程的下一章节之前，我们推荐你先学习 <a href="http://facebook.github.io/react/docs/tutorial.html" target="_blank" rel="external">React.js 的官方教程</a> - 特别是它的<a href="http://facebook.github.io/react/docs/thinking-in-react.html#step-1-break-the-ui-into-a-component-hierarchy" target="_blank" rel="external">模块化组件概念</a>以及 <a href="http://facebook.github.io/react/docs/jsx-in-depth.html" target="_blank" rel="external">JSX 语法</a>。然后阅读 <a href="http://facebook.github.io/react-native/docs/tutorial.html#content" target="_blank" rel="external">React Native 的引导教程</a>，它将展示将其用于移动应用开发的一些基础知识。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  

          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Shaopei Bian" />
          <p class="site-author-name" itemprop="name">Shaopei Bian</p>
          <p class="site-description motion-element" itemprop="description">君子终日乾乾,夕惕若厉,无咎</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/spbian" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/ptlspbian" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://weibo.com/ptlspbian" title="新浪微博" target="_blank">新浪微博</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://user.qzone.qq.com/280960487" title="QQ空间" target="_blank">QQ空间</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.ezlippi.com/blog/2016/02/jekyll-to-hexo.html" title="博客支持" target="_blank">博客支持</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2012 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shaopei Bian</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"spbian"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  












  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("MfaK8tpC2O2MyyI2Sg6c3dtB-gzGzoHsz", "miPc1PpwYyhhGtW0SMRt58JY");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


</body>
</html>
